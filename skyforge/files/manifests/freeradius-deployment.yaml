apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: freeradius
  name: freeradius
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: freeradius
  template:
    metadata:
      labels:
        app.kubernetes.io/name: freeradius
    spec:
      automountServiceAccountToken: false
      containers:
      - name: freeradius
        image: freeradius/freeradius-server:3.2.5
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -lc
        - "set -e\nexport LDAP_URL=\"$(cat /run/secrets/skyforge-ldap-url)\"\nif [\
          \ -z \"${LDAP_URL}\" ]; then\n  echo \"SKYFORGE_LDAP_URL is empty; starting\
          \ FreeRADIUS without LDAP.\"\n  exec freeradius -f\nfi\nexport LDAP_BIND_DN=\"\
          $(cat /run/secrets/skyforge-ldap-binddn)\"\nexport LDAP_BIND_PASSWORD=\"\
          $(cat /run/secrets/skyforge-ldap-bindpassword)\"\nexport LDAP_SEARCH_DN=\"\
          $(cat /run/secrets/skyforge-ldap-searchdn)\"\nexport LDAP_SEARCH_FILTER=\"\
          $(cat /run/secrets/skyforge-ldap-searchfilter)\"\ncat > /etc/raddb/mods-enabled/ldap\
          \ <<EOF\nldap {\n  server = \"${LDAP_URL}\"\n  identity = \"${LDAP_BIND_DN}\"\
          \n  password = \"${LDAP_BIND_PASSWORD}\"\n  base_dn = \"${LDAP_SEARCH_DN}\"\
          \n  filter = \"${LDAP_SEARCH_FILTER}\"\n  start_tls = no\n  tls {\n    start_tls\
          \ = no\n    require_cert = \"never\"\n  }\n  user {\n    filter = \"${LDAP_SEARCH_FILTER}\"\
          \n  }\n}\nEOF\nawk '/authorize \\\\{/{print; print \"    ldap\"; next}1'\
          \ /etc/raddb/sites-enabled/default > /tmp/default\nmv /tmp/default /etc/raddb/sites-enabled/default\n\
          awk '/authenticate \\\\{/{print; print \"    Auth-Type LDAP {\"; print \"\
          \      ldap\"; print \"    }\"; next}1' /etc/raddb/sites-enabled/default\
          \ > /tmp/default\nmv /tmp/default /etc/raddb/sites-enabled/default\nexec\
          \ freeradius -f\n"
        ports:
        - containerPort: 1812
          protocol: UDP
        - containerPort: 1813
          protocol: UDP
        volumeMounts:
        - name: run-secrets
          mountPath: /run/secrets
          readOnly: true
        - name: skyforge-ca-bundle
          mountPath: /etc/skyforge/ca
        env:
        - name: SSL_CERT_FILE
          value: /etc/skyforge/ca/ca-certificates.crt
      volumes:
      - name: run-secrets
        projected:
          sources:
          - secret:
              name: skyforge-ldap-url
              items:
              - key: skyforge-ldap-url
                path: skyforge-ldap-url
          - secret:
              name: skyforge-ldap-binddn
              items:
              - key: skyforge-ldap-binddn
                path: skyforge-ldap-binddn
          - secret:
              name: skyforge-ldap-bindpassword
              items:
              - key: skyforge-ldap-bindpassword
                path: skyforge-ldap-bindpassword
          - secret:
              name: skyforge-ldap-searchdn
              items:
              - key: skyforge-ldap-searchdn
                path: skyforge-ldap-searchdn
          - secret:
              name: skyforge-ldap-searchfilter
              items:
              - key: skyforge-ldap-searchfilter
                path: skyforge-ldap-searchfilter
      - name: skyforge-ca-cert
        secret:
          secretName: skyforge-ca-cert
      - name: skyforge-ca-bundle
        emptyDir: {}
      initContainers:
      - name: skyforge-ca-bundle
        image: alpine:3.20
        command:
        - sh
        - -c
        - cat /etc/ssl/certs/ca-certificates.crt /etc/skyforge/skyforge-ca-cert > /work/ca-certificates.crt
        volumeMounts:
        - name: skyforge-ca-cert
          mountPath: /etc/skyforge
          readOnly: true
        - name: skyforge-ca-bundle
          mountPath: /work

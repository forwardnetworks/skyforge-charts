apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: gitea-admin-sync
  name: gitea-admin-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gitea-admin-sync
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitea-admin-sync
    spec:
      automountServiceAccountToken: false
      enableServiceLinks: false
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: gitea
              topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      containers:
      - command:
        - /bin/sh
        - -c
        args:
        - |
          set -euo pipefail

          export SECRET_KEY="$(cat /run/secrets/gitea-secret-key)"
          export GITEA__database__PASSWD="$(cat /run/secrets/db-gitea-password)"

          interval="${SKYFORGE_ADMIN_SYNC_SECONDS:-30}"
          if ! echo "${interval}" | grep -Eq '^[0-9]+$' || [ "${interval}" -lt 5 ]; then
            interval="30"
          fi

          admin_username="${SKYFORGE_ADMIN_USERNAME:-}"
          admin_email="${SKYFORGE_ADMIN_EMAIL:-}"
          admin_password="$(cat /run/secrets/skyforge-admin-shared | tr -d '\n')"
          config="/var/lib/gitea/custom/conf/app.ini"

          while true; do
            if [ -z "${admin_username}" ] || [ -z "${admin_password}" ]; then
              echo "SKYFORGE_ADMIN_USERNAME/password not set; waiting..."
              sleep "${interval}"
              continue
            fi

            for i in $(seq 1 60); do
              if [ -f "${config}" ]; then
                break
              fi
              echo "Waiting for gitea config to exist at ${config} (${i}/60)..."
              sleep 2
            done

            if [ ! -f "${config}" ]; then
              echo "Gitea config not found at ${config}; retrying..."
              sleep "${interval}"
              continue
            fi

            if gitea admin user create --config "${config}" \
              --username "${admin_username}" \
              --password "${admin_password}" \
              --email "${admin_email}" \
              --admin \
              --must-change-password=false; then
              echo "Gitea admin created: ${admin_username}"
            else
              gitea admin user change-password --config "${config}" \
                --username "${admin_username}" \
                --password "${admin_password}" \
                --must-change-password=false || true
              echo "Gitea admin updated: ${admin_username}"
            fi

            gitea admin user must-change-password --config "${config}" --all --unset || true
            sleep "${interval}"
          done
        env:
        - name: SKYFORGE_ADMIN_SYNC_SECONDS
          value: '30'
        - name: SKYFORGE_ADMIN_USERNAME
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_ADMIN_USERNAME
        - name: SKYFORGE_ADMIN_EMAIL
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_ADMIN_EMAIL
        image: ghcr.io/go-gitea/gitea:1.24.6-rootless
        name: gitea-admin-sync
        securityContext:
          runAsGroup: 1000
          runAsUser: 1000
        volumeMounts:
        - mountPath: /run/secrets
          name: run-secrets
          readOnly: true
        - mountPath: /var/lib/gitea
          name: gitea-data
      restartPolicy: Always
      volumes:
      - name: run-secrets
        projected:
          sources:
          - secret:
              items:
              - key: db-gitea-password
                path: db-gitea-password
              name: db-gitea-password
          - secret:
              items:
              - key: gitea-secret-key
                path: gitea-secret-key
              name: gitea-secret-key
          - secret:
              items:
              - key: password
                path: skyforge-admin-shared
              name: skyforge-admin-shared
      - name: skyforge-ca-cert
        secret:
          secretName: skyforge-ca-cert
      - name: gitea-data
        persistentVolumeClaim:
          claimName: gitea-data

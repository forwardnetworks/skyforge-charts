apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: gitea
  name: gitea
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gitea
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitea
    spec:
      automountServiceAccountToken: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      containers:
      - args:
        - 'set -e

          export GITEA__security__SECRET_KEY="$(cat /run/secrets/gitea-secret-key)"

          export GITEA__database__PASSWD="$(cat /run/secrets/db-gitea-password)"

          exec /usr/bin/dumb-init -- /usr/local/bin/docker-entrypoint.sh

          '
        command:
        - /bin/sh
        - -c
        env:
        - name: GITEA_APP_INI
          value: /var/lib/gitea/custom/conf/app.ini
        - name: GITEA__database__DB_TYPE
          value: postgres
        - name: GITEA__database__HOST
          value: db:5432
        - name: GITEA__database__NAME
          value: gitea
        - name: GITEA__database__SSL_MODE
          value: disable
        - name: GITEA__database__USER
          value: gitea
        - name: GITEA__server__ENABLE_SSH
          value: 'true'
        - name: GITEA__server__HTTP_PORT
          value: '3000'
        - name: GITEA__server__ROOT_URL
          valueFrom:
            configMapKeyRef:
              key: GITEA_ROOT_URL
              name: skyforge-config
        - name: GITEA__server__SERVE_FROM_SUB_PATH
          value: 'false'
        - name: GITEA__server__SSH_DOMAIN
          valueFrom:
            configMapKeyRef:
              key: SKYFORGE_HOSTNAME
              name: skyforge-config
        - name: GITEA__server__SSH_LISTEN_PORT
          value: '22'
        - name: GITEA__server__SSH_PORT
          value: '22'
        - name: GITEA__server__START_SSH_SERVER
          value: 'false'
        - name: GITEA__service__DISABLE_REGISTRATION
          value: 'false'
        - name: GITEA__service__ALLOW_ONLY_EXTERNAL_REGISTRATION
          value: 'false'
        - name: GITEA__service__REVERSE_PROXY_AUTHENTICATION
          value: 'true'
        - name: GITEA__service__ENABLE_REVERSE_PROXY_AUTHENTICATION
          value: 'true'
        - name: GITEA__service__ENABLE_REVERSE_PROXY_AUTHENTICATION_API
          value: 'true'
        - name: GITEA__service__REVERSE_PROXY_AUTHENTICATION_USER
          value: 'Remote-User'
        - name: GITEA__service__REVERSE_PROXY_AUTHENTICATION_EMAIL
          value: 'Remote-User-Email'
        - name: GITEA__service__REVERSE_PROXY_AUTO_REGISTRATION
          value: 'true'
        - name: GITEA__service__ENABLE_REVERSE_PROXY_AUTO_REGISTRATION
          value: 'true'
        - name: GITEA__service__REQUIRE_SIGNIN_VIEW
          value: 'true'
        - name: GITEA__security__REVERSE_PROXY_AUTHENTICATION
          value: 'true'
        - name: GITEA__security__ENABLE_REVERSE_PROXY_AUTHENTICATION
          value: 'true'
        - name: GITEA__security__REVERSE_PROXY_AUTO_REGISTRATION
          value: 'true'
        - name: GITEA__security__ENABLE_REVERSE_PROXY_AUTO_REGISTRATION
          value: 'true'
        - name: GITEA__security__REVERSE_PROXY_AUTHENTICATION_USER
          value: 'Remote-User'
        - name: GITEA__security__REVERSE_PROXY_AUTHENTICATION_EMAIL
          value: 'Remote-User-Email'
        - name: GITEA__security__REVERSE_PROXY_LIMIT
          value: '1'
        - name: GITEA__security__REVERSE_PROXY_TRUSTED_PROXIES
          value: '0.0.0.0/0,::/0'
        - name: GITEA__service__RESERVED_USERNAMES
          value: ''
        - name: GITEA__user__RESERVED_USERNAMES
          value: ''
        - name: GITEA__user__RESTRICTED_USERNAMES
          value: ''
        - name: GITEA__migrations__ALLOW_LOCALNETWORKS
          value: 'true'
        - name: GITEA__migrations__ALLOWED_DOMAINS
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: GITEA_ALLOWED_DOMAINS
        - name: GITEA__migrations__SKIP_TLS_VERIFY
          value: 'true'
        # Store large artifacts in object storage (S3), while keeping
        # repository data on the filesystem-backed PVC.
        #
        # Leave per-feature storage types unset so they derive from [storage].
        - name: GITEA__storage__STORAGE_TYPE
          value: minio
        - name: GITEA__storage__MINIO_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_OBJECT_STORAGE_ENDPOINT
        - name: GITEA__storage__MINIO_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: object-storage-root-user
              key: object-storage-root-user
        - name: GITEA__storage__MINIO_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: object-storage-root-password
              key: object-storage-root-password
        - name: GITEA__storage__MINIO_BUCKET
          value: gitea
        - name: GITEA__storage__MINIO_LOCATION
          value: us-east-1
        - name: GITEA__storage__MINIO_USE_SSL
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_OBJECT_STORAGE_USE_SSL
        - name: GITEA__storage__MINIO_BUCKET_LOOKUP_TYPE
          value: path
        - name: GITEA__attachment__STORAGE_TYPE
          value: default
        - name: GITEA__lfs__STORAGE_TYPE
          value: default
        # Allow Gitea to pick up S3 credentials automatically.
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: object-storage-root-user
              key: object-storage-root-user
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: object-storage-root-password
              key: object-storage-root-password
        - name: GITEA__security__INSTALL_LOCK
          value: 'true'
        - name: USER_GID
          value: '1000'
        - name: USER_UID
          value: '1000'
        - name: SSL_CERT_FILE
          value: /etc/skyforge/ca/ca-certificates.crt
        image: ghcr.io/go-gitea/gitea:1.24.6-rootless
        livenessProbe:
          httpGet:
            path: /
            port: 3000
          failureThreshold: 6
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 2
        readinessProbe:
          httpGet:
            path: /
            port: 3000
          failureThreshold: 3
          periodSeconds: 5
          timeoutSeconds: 2
        name: gitea
        ports:
        - containerPort: 3000
          protocol: TCP
        resources:
          limits:
            memory: '1073741824'
        volumeMounts:
        - mountPath: /run/secrets
          name: run-secrets
          readOnly: true
        - mountPath: /var/lib/gitea
          name: gitea-data
        - name: skyforge-ca-bundle
          mountPath: /etc/skyforge/ca
      restartPolicy: Always
      volumes:
      - name: run-secrets
        projected:
          sources:
          - secret:
              items:
              - key: db-gitea-password
                path: db-gitea-password
              name: db-gitea-password
          - secret:
              items:
              - key: gitea-secret-key
                path: gitea-secret-key
              name: gitea-secret-key
      - name: gitea-data
        persistentVolumeClaim:
          claimName: gitea-data
      - name: skyforge-ca-cert
        secret:
          secretName: skyforge-ca-cert
      - name: skyforge-ca-bundle
        emptyDir: {}
      initContainers:
      - name: skyforge-ca-bundle
        image: alpine:3.20
        command:
        - sh
        - -c
        - cat /etc/ssl/certs/ca-certificates.crt /etc/skyforge/skyforge-ca-cert > /work/ca-certificates.crt
        volumeMounts:
        - name: skyforge-ca-cert
          mountPath: /etc/skyforge
          readOnly: true
        - name: skyforge-ca-bundle
          mountPath: /work
      - name: gitea-storage-default
        image: alpine:3.20
        command:
        - sh
        - -lc
        - |
          set -euo pipefail
          ini="/var/lib/gitea/custom/conf/app.ini"
          mkdir -p "$(dirname "$ini")"
          touch "$ini"
          # Always reconcile the default storage stanza. This file lives on a PVC,
          # and leaving stale values (for example from prior experiments) can prevent
          # Gitea from starting.
          if grep -qE '^[[]storage[.]default[]]' "$ini"; then
            awk '
              BEGIN{skip=0}
              /^[[]storage[.]default[]]/{skip=1; next}
              /^[[]/{if(skip){skip=0}}
              {if(!skip) print}
            ' "$ini" > "${ini}.tmp"
            mv "${ini}.tmp" "$ini"
          fi
          printf '\n[storage.default]\nSTORAGE_TYPE = minio\nMINIO_ENDPOINT = %s\nMINIO_BUCKET = gitea\nMINIO_LOCATION = us-east-1\nMINIO_USE_SSL = %s\nMINIO_BUCKET_LOOKUP_TYPE = path\n' \
            "$SKYFORGE_OBJECT_STORAGE_ENDPOINT" "$SKYFORGE_OBJECT_STORAGE_USE_SSL" >>"$ini"
          # The gitea image runs rootless (uid/gid 1000). Ensure the config file
          # is writable by that user, otherwise `environment-to-ini` (run during
          # the next init container) will fail and `gitea migrate` will never run.
          chown 1000:1000 "$ini"
          chmod 0640 "$ini"
        env:
        - name: SKYFORGE_OBJECT_STORAGE_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_OBJECT_STORAGE_ENDPOINT
        - name: SKYFORGE_OBJECT_STORAGE_USE_SSL
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_OBJECT_STORAGE_USE_SSL
        volumeMounts:
        - name: gitea-data
          mountPath: /var/lib/gitea
      - name: gitea-migrate
        image: ghcr.io/go-gitea/gitea:1.24.6-rootless
        command:
          - /bin/sh
          - -c
        args:
          - |
            set -euo pipefail
            export GITEA_APP_INI=/var/lib/gitea/custom/conf/app.ini
            export GITEA__security__SECRET_KEY="$(cat /run/secrets/gitea-secret-key)"
            export GITEA__database__PASSWD="$(cat /run/secrets/db-gitea-password)"
            export GITEA__security__INSTALL_LOCK=true
            /usr/local/bin/environment-to-ini >/dev/null
            # Gitea's --config flag is a *global* flag (must be before the subcommand).
            /usr/local/bin/gitea --config "${GITEA_APP_INI}" migrate
        env:
          - name: GITEA__database__DB_TYPE
            value: postgres
          - name: GITEA__database__HOST
            value: db:5432
          - name: GITEA__database__NAME
            value: gitea
          - name: GITEA__database__SSL_MODE
            value: disable
          - name: GITEA__database__USER
            value: gitea
        volumeMounts:
          - name: run-secrets
            mountPath: /run/secrets
            readOnly: true
          - name: gitea-data
            mountPath: /var/lib/gitea

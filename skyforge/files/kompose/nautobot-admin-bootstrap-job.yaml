apiVersion: batch/v1
kind: Job
metadata:
  labels:
    io.kompose.service: nautobot-admin-bootstrap
  name: nautobot-admin-bootstrap
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        io.kompose.service: nautobot-admin-bootstrap
    spec:
      automountServiceAccountToken: false
      enableServiceLinks: false
      containers:
        - args:
            - |
              set -eu
              export NAUTOBOT_DB_PASSWORD="$(cat /run/secrets/db-nautobot-password)"
              export NAUTOBOT_SECRET_KEY="$(cat /run/secrets/nautobot-secret-key)"
              export SKYFORGE_ADMIN_PASSWORD_FILE="/run/secrets/skyforge-admin-shared"

              for i in $(seq 1 60); do
                if nautobot-server shell --command "print('ready')" >/dev/null 2>&1; then
                  break
                fi
                sleep 2
              done

              nautobot-server shell --command "import os; from django.contrib.auth import get_user_model; password=open(os.environ['SKYFORGE_ADMIN_PASSWORD_FILE'], encoding='utf-8').read().strip(); username=os.environ.get('SKYFORGE_ADMIN_USERNAME','skyforge'); email=os.environ.get('SKYFORGE_ADMIN_EMAIL',''); User=get_user_model(); user,_=User.objects.get_or_create(username=username); user.email=email; user.is_active=True; user.is_staff=True; user.is_superuser=True; user.set_password(password); user.save(); print('nautobot admin synced:', user.username)"
          command:
            - /bin/sh
            - -c
          env:
            - name: NAUTOBOT_DB_HOST
              value: db
            - name: NAUTOBOT_DB_NAME
              value: nautobot
            - name: NAUTOBOT_DB_PORT
              value: "5432"
            - name: NAUTOBOT_DB_USER
              value: nautobot
            - name: SKYFORGE_ADMIN_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_USERNAME
            - name: SKYFORGE_ADMIN_EMAIL
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_EMAIL
          image: ghcr.io/forwardnetworks/skyforge-nautobot:20260108-0135
          imagePullPolicy: IfNotPresent
          name: nautobot-admin-bootstrap
          volumeMounts:
            - mountPath: /run/secrets
              name: run-secrets
              readOnly: true
      restartPolicy: OnFailure
      volumes:
        - name: run-secrets
          projected:
            sources:
              - secret:
                  items:
                    - key: db-nautobot-password
                      path: db-nautobot-password
                  name: db-nautobot-password
              - secret:
                  items:
                    - key: nautobot-secret-key
                      path: nautobot-secret-key
                  name: nautobot-secret-key
              - secret:
                  items:
                    - key: password
                      path: skyforge-admin-shared
                  name: skyforge-admin-shared

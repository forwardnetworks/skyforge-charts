apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    io.kompose.service: code-workspace-sync
  name: code-workspace-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: code-workspace-sync
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        io.kompose.service: code-workspace-sync
    spec:
      automountServiceAccountToken: false
      containers:
      - args:
        - "set -euo pipefail\napk add --no-cache git jq ca-certificates curl >/dev/null\n\
          \ninterval=\"${SKYFORGE_WORKSPACE_SYNC_INTERVAL:-60}\"\nif ! echo \"${interval}\"\
          \ | grep -Eq '^[0-9]+$' || [ \"${interval}\" -lt 10 ]; then\n  interval=\"\
          60\"\nfi\n\nworkspace_root=\"/workspace/projects\"\nuser_root=\"/workspace/users\"\
          \nmkdir -p \"${workspace_root}\" \"${user_root}\"\n\ntoken_file=\"/run/secrets/skyforge-internal-token\"\
          \ngitea_password_file=\"/run/secrets/skyforge-admin-shared\"\ns3_access_key_file=\"\
          /run/secrets/object-storage-artifacts-access-key\"\ns3_secret_key_file=\"\
          /run/secrets/object-storage-artifacts-secret-key\"\ns3_root_user_file=\"\
          /run/secrets/object-storage-root-user\"\ns3_root_password_file=\"/run/secrets/object-storage-root-password\"\
          \ngitea_user=\"${GITEA_SYNC_USERNAME:-skyforge}\"\nexport_url=\"http://skyforge-server:8085/api/internal/projects-export\"\
          \npublic_owner=\"${GITEA_PUBLIC_OWNER:-skyforge}\"\npublic_root=\"${workspace_root}/public\"\
          \nmkdir -p \"${public_root}\"\ns3_bucket=\"${SKYFORGE_WORKSPACE_S3_BUCKET:-skyforge}\"\
          \ns3_endpoint=\"${SKYFORGE_OBJECT_STORAGE_ENDPOINT:-minio:9000}\"\ns3_use_ssl=\"\
          ${SKYFORGE_OBJECT_STORAGE_USE_SSL:-false}\"\ns3_scheme=\"http\"\nif [ \"\
          ${s3_use_ssl}\" = \"true\" ]; then\n  s3_scheme=\"https\"\nfi\ns3_url=\"\
          ${s3_scheme}://${s3_endpoint}\"\nmc_config_dir=\"/tmp/.mc\"\n\ngitea_password=\"\
          \"\nif [ -f \"${gitea_password_file}\" ]; then\n  gitea_password=\"$(cat\
          \ \"${gitea_password_file}\" 2>/dev/null | tr -d '\\r\\n' || true)\"\nfi\n\
          \ns3_access_key=\"\"\ns3_secret_key=\"\"\nif [ -f \"${s3_access_key_file}\"\
          \ ]; then\n  s3_access_key=\"$(cat \"${s3_access_key_file}\" 2>/dev/null\
          \ | tr -d '\\r\\n' || true)\"\nfi\nif [ -f \"${s3_secret_key_file}\" ];\
          \ then\n  s3_secret_key=\"$(cat \"${s3_secret_key_file}\" 2>/dev/null |\
          \ tr -d '\\r\\n' || true)\"\nfi\nif [ -z \"${s3_access_key}\" ] && [ -f\
          \ \"${s3_root_user_file}\" ]; then\n  s3_access_key=\"$(cat \"${s3_root_user_file}\"\
          \ 2>/dev/null | tr -d '\\r\\n' || true)\"\nfi\nif [ -z \"${s3_secret_key}\"\
          \ ] && [ -f \"${s3_root_password_file}\" ]; then\n  s3_secret_key=\"$(cat\
          \ \"${s3_root_password_file}\" 2>/dev/null | tr -d '\\r\\n' || true)\"\n\
          fi\n\nif [ -n \"${gitea_password}\" ]; then\n  export GIT_TERMINAL_PROMPT=0\n\
          \  export DISPLAY=1\n  cat >/tmp/askpass <<'EOF'\n#!/bin/sh\nprintenv GIT_PASSWORD\n\
          EOF\n  chmod 700 /tmp/askpass\n  export GIT_ASKPASS=/tmp/askpass\n  export\
          \ SSH_ASKPASS=/tmp/askpass\n  export GIT_PASSWORD=\"${gitea_password}\"\n\
          fi\n\nsync_repo() {\n  local slug=\"$1\"\n  local owner=\"$2\"\n  local\
          \ repo=\"$3\"\n  local branch=\"$4\"\n  local dest=\"$5\"\n\n  [ -n \"${branch}\"\
          \ ] || branch=\"master\"\n  remote=\"http://gitea:3000/${owner}/${repo}.git\"\
          \n  git_run() {\n    if [ -n \"${gitea_password}\" ]; then\n      git -c\
          \ \"credential.username=${gitea_user}\" \"$@\"\n    else\n      git \"$@\"\
          \n    fi\n  }\n\n  if [ ! -d \"${dest}/.git\" ]; then\n    rm -rf \"${dest}\"\
          \ >/dev/null 2>&1 || true\n    git_run clone --depth 1 --branch \"${branch}\"\
          \ \"${remote}\" \"${dest}\" >/dev/null 2>&1 || true\n  else\n    git -C\
          \ \"${dest}\" remote set-url origin \"${remote}\" >/dev/null 2>&1 || true\n\
          \    git_run -C \"${dest}\" fetch --depth 1 origin \"${branch}\" >/dev/null\
          \ 2>&1 || true\n    git_run -C \"${dest}\" checkout -B \"${branch}\" \"\
          origin/${branch}\" >/dev/null 2>&1 || true\n  fi\n}\n\nensure_mc() {\n \
          \ if command -v mc >/dev/null 2>&1; then\n    return 0\n  fi\n  mkdir -p\
          \ /usr/local/bin\n  curl -fsSL -o /usr/local/bin/mc https://dl.min.io/client/mc/release/linux-amd64/mc\
          \ >/dev/null 2>&1 || return 1\n  chmod +x /usr/local/bin/mc >/dev/null 2>&1\
          \ || true\n}\n\nsync_user_s3() {\n  local username=\"$1\"\n  local user_dir=\"\
          $2\"\n  if [ -z \"${s3_access_key}\" ] || [ -z \"${s3_secret_key}\" ] ||\
          \ [ -z \"${s3_endpoint}\" ]; then\n    return 0\n  fi\n  if ! ensure_mc;\
          \ then\n    return 0\n  fi\n  mc alias set skyforge \"${s3_url}\" \"${s3_access_key}\"\
          \ \"${s3_secret_key}\" --api S3v4 --config-dir \"${mc_config_dir}\" >/dev/null\
          \ 2>&1 || true\n  mc mirror --overwrite --newer --quiet --config-dir \"\
          ${mc_config_dir}\" \"skyforge/${s3_bucket}/files/users/${username}/\" \"\
          ${user_dir}/s3\" >/dev/null 2>&1 || true\n  mc mirror --overwrite --newer\
          \ --quiet --config-dir \"${mc_config_dir}\" \"skyforge/${s3_bucket}/anonymous/\"\
          \ \"${user_dir}/anonymous\" >/dev/null 2>&1 || true\n  mc mirror --overwrite\
          \ --newer --quiet --config-dir \"${mc_config_dir}\" \"skyforge/${s3_bucket}/files/anonymous/\"\
          \ \"${user_dir}/anonymous\" >/dev/null 2>&1 || true\n}\n\nensure_user_scaffold()\
          \ {\n  local user_dir=\"$1\"\n  local username=\"$2\"\n  local readme=\"\
          ${user_dir}/README.md\"\n  if [ ! -f \"${readme}\" ]; then\n    cat >\"\
          ${readme}\" <<EOF\n# Skyforge user workspace\n\nWelcome, ${username}. This\
          \ folder is your Skyforge workspace.\n\n## Git repos\n- Project repos you\
          \ can access are synced into this folder.\n- The sync job runs every minute\
          \ and may overwrite local changes.\n- To keep changes, commit and push to\
          \ Gitea:\n  git status\n  git add -A\n  git commit -m \"Describe your change\"\
          \n  git push\n\n## Shared projects\n- Shared project clones live in /workspace/projects.\n\
          \n## S3 / MinIO artifacts\n- Use the S3 console at https://<skyforge-host>/minio-console/\n\
          - Store personal artifacts under files/users/${username}/\n- Anonymous file\
          \ drop uses anonymous/ or files/\n- S3 files are mirrored into s3/ every\
          \ minute (download-only).\n- Do not edit files in s3/ directly; upload via\
          \ S3 instead.\n- Example (mc):\n  mc alias set skyforge https://<skyforge-host>\
          \ <ACCESS_KEY> <SECRET_KEY>\n  mc ls skyforge/skyforge-files/files/users/${username}/\n\
          \  mc cp skyforge/skyforge-files/files/users/${username}/file.txt ./s3/\n\
          - Example (anonymous drop):\n  curl -T ./file.txt https://<skyforge-host>/files/file.txt\n\
          EOF\n  fi\n\n  mkdir -p \"${user_dir}/s3\" \"${user_dir}/anonymous\"\n \
          \ if [ ! -f \"${user_dir}/s3/README.md\" ]; then\n    cat >\"${user_dir}/s3/README.md\"\
          \ <<EOF\n# S3 files (MinIO)\n\nThis folder is an auto-mirror of your S3\
          \ artifacts (download-only).\nUpload via the MinIO console or an S3 client.\n\
          EOF\n  fi\n  if [ ! -f \"${user_dir}/anonymous/README.md\" ]; then\n   \
          \ cat >\"${user_dir}/anonymous/README.md\" <<EOF\n# Anonymous files\n\n\
          Anonymous uploads land in the MinIO bucket under anonymous/ or files/.\n\
          Copy anything you need into this folder.\nEOF\n  fi\n}\n\necho \"code-workspace-sync:\
          \ starting (interval=${interval}s)\"\necho \"code-workspace-sync: public\
          \ owner=${public_owner}\"\n\nsync_public_repos() {\n  local repos_json\n\
          \  repos_json=\"$(curl -fsS \"http://gitea:3000/api/v1/orgs/${public_owner}/repos?limit=100\"\
          \ 2>/dev/null || true)\"\n  if [ -z \"${repos_json}\" ]; then\n    repos_json=\"\
          $(curl -fsS \"http://gitea:3000/api/v1/users/${public_owner}/repos?limit=100\"\
          \ 2>/dev/null || true)\"\n  fi\n  if [ -n \"${repos_json}\" ]; then\n  \
          \  echo \"${repos_json}\" \\\n      | jq -r '.[]? | (.name + \"\\t\" + .owner.login\
          \ + \"\\t\" + (.default_branch // \"master\"))' \\\n      | while IFS=$'\\\
          t' read -r repo owner branch; do\n          [ -n \"${repo}\" ] || continue\n\
          \          [ -n \"${owner}\" ] || continue\n          dest=\"${public_root}/${repo}\"\
          \n          sync_repo \"${repo}\" \"${owner}\" \"${repo}\" \"${branch}\"\
          \ \"${dest}\"\n        done\n  else\n    echo \"code-workspace-sync: public\
          \ repo list unavailable\"\n  fi\n}\n\nwhile true; do\n  if [ ! -f \"${token_file}\"\
          \ ]; then\n    sync_public_repos\n    sleep \"${interval}\"\n    continue\n\
          \  fi\n\n  token=\"$(cat \"${token_file}\" 2>/dev/null | tr -d '\\r\\n'\
          \ || true)\"\n  if [ -z \"${token}\" ]; then\n    sync_public_repos\n  \
          \  sleep \"${interval}\"\n    continue\n  fi\n\n  tmp=\"/tmp/projects-export.json\"\
          \n  code=\"$(curl -sS -H \"X-Skyforge-Internal-Token: ${token}\" -o \"${tmp}\"\
          \ -w \"%{http_code}\" \"${export_url}\" 2>/dev/null || true)\"\n  if [ \"\
          ${code}\" != \"200\" ]; then\n    echo \"code-workspace-sync: export fetch\
          \ failed (http=${code:-000})\"\n    sleep \"${interval}\"\n    continue\n\
          \  fi\n  export_json=\"$(cat \"${tmp}\" 2>/dev/null || true)\"\n  if [ -z\
          \ \"${export_json}\" ]; then\n    echo \"code-workspace-sync: export fetch\
          \ returned empty body\"\n    sleep \"${interval}\"\n    continue\n  fi\n\
          \n  pcount=\"$(echo \"${export_json}\" | jq '.projects | length' 2>/dev/null\
          \ || echo 0)\"\n  ucount=\"$(echo \"${export_json}\" | jq '[.users[]?] |\
          \ length' 2>/dev/null || echo 0)\"\n  echo \"code-workspace-sync: export\
          \ ok (projects=${pcount} users=${ucount})\"\n\n  echo \"${export_json}\"\
          \ \\\n    | jq -r '.projects[]? | (.slug + \"\\t\" + .giteaOwner + \"\\\
          t\" + .giteaRepo + \"\\t\" + (.defaultBranch // \"master\"))' \\\n    |\
          \ while IFS=$'\\t' read -r slug owner repo branch; do\n        [ -n \"${slug}\"\
          \ ] || continue\n        [ -n \"${owner}\" ] || continue\n        [ -n \"\
          ${repo}\" ] || continue\n        dest=\"${workspace_root}/${slug}\"\n  \
          \      sync_repo \"${slug}\" \"${owner}\" \"${repo}\" \"${branch}\" \"${dest}\"\
          \n      done\n\n  echo \"${export_json}\" \\\n    | jq -r '\n        [\n\
          \          .users[]?,\n          (.projects[]?.createdBy // \"\"),\n   \
          \       (.projects[]?.owners[]? // \"\"),\n          (.projects[]?.editors[]?\
          \ // \"\"),\n          (.projects[]?.viewers[]? // \"\")\n        ]\n  \
          \      | map(ascii_downcase)\n        | map(select(test(\"^[a-zA-Z0-9_.@-]+$\"\
          )))\n        | unique\n        | .[]\n      ' \\\n    | while read -r username;\
          \ do\n        [ -n \"${username}\" ] || continue\n        user_dir=\"${user_root}/${username}\"\
          \n        mkdir -p \"${user_dir}\"\n        ensure_user_scaffold \"${user_dir}\"\
          \ \"${username}\"\n        sync_user_s3 \"${username}\" \"${user_dir}\"\n\
          \necho \"${export_json}\" \\\n  | jq -r --arg u \"${username}\" '\n    \
          \  .projects[]?\n      | select(\n          ((.createdBy // \"\" | ascii_downcase)\
          \ == $u)\n          or ((.owners // [] | map(ascii_downcase) | index($u))\
          \ != null)\n          or ((.editors // [] | map(ascii_downcase) | index($u))\
          \ != null)\n          or ((.viewers // [] | map(ascii_downcase) | index($u))\
          \ != null)\n        )\n      | (.slug + \"\\t\" + .giteaOwner + \"\\t\"\
          \ + .giteaRepo + \"\\t\" + (.defaultBranch // \"master\"))\n    ' \\\n \
          \ | while IFS=$'\\t' read -r slug owner repo branch; do\n      [ -n \"${slug}\"\
          \ ] || continue\n      [ -n \"${owner}\" ] || continue\n      [ -n \"${repo}\"\
          \ ] || continue\n              dest=\"${user_dir}/${slug}\"\n          \
          \    sync_repo \"${slug}\" \"${owner}\" \"${repo}\" \"${branch}\" \"${dest}\"\
          \n      done\n      done\n\n  sync_public_repos\n\n  sleep \"${interval}\"\
          \ndone\n"
        command:
        - /bin/sh
        - -lc
        env:
        - name: SKYFORGE_WORKSPACE_SYNC_INTERVAL
          value: '60'
        - name: SKYFORGE_OBJECT_STORAGE_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_OBJECT_STORAGE_ENDPOINT
        - name: SKYFORGE_OBJECT_STORAGE_USE_SSL
          valueFrom:
            configMapKeyRef:
              name: skyforge-config
              key: SKYFORGE_OBJECT_STORAGE_USE_SSL
        - name: SKYFORGE_WORKSPACE_S3_BUCKET
          value: skyforge-files
        - name: SSL_CERT_FILE
          value: /etc/skyforge/ca/ca-certificates.crt
        image: alpine:3.20
        name: code-workspace-sync
        volumeMounts:
        - mountPath: /workspace
          name: shared-workspace
        - mountPath: /run/secrets
          name: run-secrets
          readOnly: true
        - name: skyforge-ca-bundle
          mountPath: /etc/skyforge/ca
      restartPolicy: Always
      volumes:
      - name: shared-workspace
        persistentVolumeClaim:
          claimName: shared-workspace
      - name: run-secrets
        projected:
          sources:
          - secret:
              items:
              - key: skyforge-internal-token
                path: skyforge-internal-token
              name: skyforge-internal-token
              optional: true
          - secret:
              items:
              - key: password
                path: skyforge-admin-shared
              name: skyforge-admin-shared
          - secret:
              items:
              - key: object-storage-artifacts-access-key
                path: object-storage-artifacts-access-key
              name: object-storage-artifacts-access-key
              optional: true
          - secret:
              items:
              - key: object-storage-artifacts-secret-key
                path: object-storage-artifacts-secret-key
              name: object-storage-artifacts-secret-key
              optional: true
          - secret:
              items:
              - key: object-storage-root-user
                path: object-storage-root-user
              name: object-storage-root-user
              optional: true
          - secret:
              items:
              - key: object-storage-root-password
                path: object-storage-root-password
              name: object-storage-root-password
              optional: true
      - name: skyforge-ca-cert
        secret:
          secretName: skyforge-ca-cert
      - name: skyforge-ca-bundle
        emptyDir: {}
      initContainers:
      - name: skyforge-ca-bundle
        image: alpine:3.20
        command:
        - sh
        - -c
        - cat /etc/ssl/certs/ca-certificates.crt /etc/skyforge/skyforge-ca-cert > /work/ca-certificates.crt
        volumeMounts:
        - name: skyforge-ca-cert
          mountPath: /etc/skyforge
          readOnly: true
        - name: skyforge-ca-bundle
          mountPath: /work

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    io.kompose.service: code-workspace-sync
  name: code-workspace-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: code-workspace-sync
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        io.kompose.service: code-workspace-sync
    spec:
      automountServiceAccountToken: false
      containers:
        - args:
            - |
              set -euo pipefail
              apk add --no-cache git jq ca-certificates curl >/dev/null

              interval="${SKYFORGE_WORKSPACE_SYNC_INTERVAL:-60}"
              if ! echo "${interval}" | grep -Eq '^[0-9]+$' || [ "${interval}" -lt 10 ]; then
                interval="60"
              fi

              workspace_root="/workspace/projects"
              user_root="/workspace/users"
              mkdir -p "${workspace_root}" "${user_root}"

              token_file="/run/secrets/skyforge-internal-token"
              gitea_password_file="/run/secrets/skyforge-admin-shared"
              s3_access_key_file="/run/secrets/object-storage-artifacts-access-key"
              s3_secret_key_file="/run/secrets/object-storage-artifacts-secret-key"
              s3_root_user_file="/run/secrets/object-storage-root-user"
              s3_root_password_file="/run/secrets/object-storage-root-password"
              gitea_user="${GITEA_SYNC_USERNAME:-skyforge}"
              export_url="http://skyforge-server:8085/api/internal/projects-export"
              public_owner="${GITEA_PUBLIC_OWNER:-skyforge}"
              public_root="${workspace_root}/public"
              mkdir -p "${public_root}"
              s3_bucket="${SKYFORGE_WORKSPACE_S3_BUCKET:-skyforge}"
              s3_endpoint="${SKYFORGE_OBJECT_STORAGE_ENDPOINT:-minio:9000}"
              s3_use_ssl="${SKYFORGE_OBJECT_STORAGE_USE_SSL:-false}"
              s3_scheme="http"
              if [ "${s3_use_ssl}" = "true" ]; then
                s3_scheme="https"
              fi
              s3_url="${s3_scheme}://${s3_endpoint}"
              mc_config_dir="/tmp/.mc"

              gitea_password=""
              if [ -f "${gitea_password_file}" ]; then
                gitea_password="$(cat "${gitea_password_file}" 2>/dev/null | tr -d '\r\n' || true)"
              fi

              s3_access_key=""
              s3_secret_key=""
              if [ -f "${s3_access_key_file}" ]; then
                s3_access_key="$(cat "${s3_access_key_file}" 2>/dev/null | tr -d '\r\n' || true)"
              fi
              if [ -f "${s3_secret_key_file}" ]; then
                s3_secret_key="$(cat "${s3_secret_key_file}" 2>/dev/null | tr -d '\r\n' || true)"
              fi
              if [ -z "${s3_access_key}" ] && [ -f "${s3_root_user_file}" ]; then
                s3_access_key="$(cat "${s3_root_user_file}" 2>/dev/null | tr -d '\r\n' || true)"
              fi
              if [ -z "${s3_secret_key}" ] && [ -f "${s3_root_password_file}" ]; then
                s3_secret_key="$(cat "${s3_root_password_file}" 2>/dev/null | tr -d '\r\n' || true)"
              fi

              if [ -n "${gitea_password}" ]; then
                export GIT_TERMINAL_PROMPT=0
                export DISPLAY=1
                cat >/tmp/askpass <<'EOF'
              #!/bin/sh
              printenv GIT_PASSWORD
              EOF
                chmod 700 /tmp/askpass
                export GIT_ASKPASS=/tmp/askpass
                export SSH_ASKPASS=/tmp/askpass
                export GIT_PASSWORD="${gitea_password}"
              fi

              sync_repo() {
                local slug="$1"
                local owner="$2"
                local repo="$3"
                local branch="$4"
                local dest="$5"

                [ -n "${branch}" ] || branch="master"
                remote="http://gitea:3000/${owner}/${repo}.git"
                git_run() {
                  if [ -n "${gitea_password}" ]; then
                    git -c "credential.username=${gitea_user}" "$@"
                  else
                    git "$@"
                  fi
                }

                if [ ! -d "${dest}/.git" ]; then
                  rm -rf "${dest}" >/dev/null 2>&1 || true
                  git_run clone --depth 1 --branch "${branch}" "${remote}" "${dest}" >/dev/null 2>&1 || true
                else
                  git -C "${dest}" remote set-url origin "${remote}" >/dev/null 2>&1 || true
                  git_run -C "${dest}" fetch --depth 1 origin "${branch}" >/dev/null 2>&1 || true
                  git_run -C "${dest}" checkout -B "${branch}" "origin/${branch}" >/dev/null 2>&1 || true
                fi
              }

              ensure_mc() {
                if command -v mc >/dev/null 2>&1; then
                  return 0
                fi
                mkdir -p /usr/local/bin
                curl -fsSL -o /usr/local/bin/mc https://dl.min.io/client/mc/release/linux-amd64/mc >/dev/null 2>&1 || return 1
                chmod +x /usr/local/bin/mc >/dev/null 2>&1 || true
              }

              sync_user_s3() {
                local username="$1"
                local user_dir="$2"
                if [ -z "${s3_access_key}" ] || [ -z "${s3_secret_key}" ] || [ -z "${s3_endpoint}" ]; then
                  return 0
                fi
                if ! ensure_mc; then
                  return 0
                fi
                mc alias set skyforge "${s3_url}" "${s3_access_key}" "${s3_secret_key}" --api S3v4 --config-dir "${mc_config_dir}" >/dev/null 2>&1 || true
                mc mirror --overwrite --newer --quiet --config-dir "${mc_config_dir}" "skyforge/${s3_bucket}/files/users/${username}/" "${user_dir}/s3" >/dev/null 2>&1 || true
                mc mirror --overwrite --newer --quiet --config-dir "${mc_config_dir}" "skyforge/${s3_bucket}/anonymous/" "${user_dir}/anonymous" >/dev/null 2>&1 || true
                mc mirror --overwrite --newer --quiet --config-dir "${mc_config_dir}" "skyforge/${s3_bucket}/files/anonymous/" "${user_dir}/anonymous" >/dev/null 2>&1 || true
              }

              ensure_user_scaffold() {
                local user_dir="$1"
                local username="$2"
                local readme="${user_dir}/README.md"
                if [ ! -f "${readme}" ]; then
                  cat >"${readme}" <<EOF
              # Skyforge user workspace

              Welcome, ${username}. This folder is your Skyforge workspace.

              ## Git repos
              - Project repos you can access are synced into this folder.
              - The sync job runs every minute and may overwrite local changes.
              - To keep changes, commit and push to Gitea:
                git status
                git add -A
                git commit -m "Describe your change"
                git push

              ## Shared projects
              - Shared project clones live in /workspace/projects.

              ## S3 / MinIO artifacts
              - Use the S3 console at https://<skyforge-host>/minio-console/
              - Store personal artifacts under files/users/${username}/
              - Anonymous file drop uses anonymous/ or files/
              - S3 files are mirrored into s3/ every minute (download-only).
              - Do not edit files in s3/ directly; upload via S3 instead.
              - Example (mc):
                mc alias set skyforge https://<skyforge-host> <ACCESS_KEY> <SECRET_KEY>
                mc ls skyforge/skyforge-files/files/users/${username}/
                mc cp skyforge/skyforge-files/files/users/${username}/file.txt ./s3/
              - Example (anonymous drop):
                curl -T ./file.txt https://<skyforge-host>/files/file.txt
              EOF
                fi

                mkdir -p "${user_dir}/s3" "${user_dir}/anonymous"
                if [ ! -f "${user_dir}/s3/README.md" ]; then
                  cat >"${user_dir}/s3/README.md" <<EOF
              # S3 files (MinIO)

              This folder is an auto-mirror of your S3 artifacts (download-only).
              Upload via the MinIO console or an S3 client.
              EOF
                fi
                if [ ! -f "${user_dir}/anonymous/README.md" ]; then
                  cat >"${user_dir}/anonymous/README.md" <<EOF
              # Anonymous files

              Anonymous uploads land in the MinIO bucket under anonymous/ or files/.
              Copy anything you need into this folder.
              EOF
                fi
              }

              echo "code-workspace-sync: starting (interval=${interval}s)"
              echo "code-workspace-sync: public owner=${public_owner}"

              sync_public_repos() {
                local repos_json
                repos_json="$(curl -fsS "http://gitea:3000/api/v1/orgs/${public_owner}/repos?limit=100" 2>/dev/null || true)"
                if [ -z "${repos_json}" ]; then
                  repos_json="$(curl -fsS "http://gitea:3000/api/v1/users/${public_owner}/repos?limit=100" 2>/dev/null || true)"
                fi
                if [ -n "${repos_json}" ]; then
                  echo "${repos_json}" \
                    | jq -r '.[]? | (.name + "\t" + .owner.login + "\t" + (.default_branch // "master"))' \
                    | while IFS=$'\t' read -r repo owner branch; do
                        [ -n "${repo}" ] || continue
                        [ -n "${owner}" ] || continue
                        dest="${public_root}/${repo}"
                        sync_repo "${repo}" "${owner}" "${repo}" "${branch}" "${dest}"
                      done
                else
                  echo "code-workspace-sync: public repo list unavailable"
                fi
              }

              while true; do
                if [ ! -f "${token_file}" ]; then
                  sync_public_repos
                  sleep "${interval}"
                  continue
                fi

                token="$(cat "${token_file}" 2>/dev/null | tr -d '\r\n' || true)"
                if [ -z "${token}" ]; then
                  sync_public_repos
                  sleep "${interval}"
                  continue
                fi

                tmp="/tmp/projects-export.json"
                code="$(curl -sS -H "X-Skyforge-Internal-Token: ${token}" -o "${tmp}" -w "%{http_code}" "${export_url}" 2>/dev/null || true)"
                if [ "${code}" != "200" ]; then
                  echo "code-workspace-sync: export fetch failed (http=${code:-000})"
                  sleep "${interval}"
                  continue
                fi
                export_json="$(cat "${tmp}" 2>/dev/null || true)"
                if [ -z "${export_json}" ]; then
                  echo "code-workspace-sync: export fetch returned empty body"
                  sleep "${interval}"
                  continue
                fi

                pcount="$(echo "${export_json}" | jq '.projects | length' 2>/dev/null || echo 0)"
                ucount="$(echo "${export_json}" | jq '[.users[]?] | length' 2>/dev/null || echo 0)"
                echo "code-workspace-sync: export ok (projects=${pcount} users=${ucount})"

                echo "${export_json}" \
                  | jq -r '.projects[]? | (.slug + "\t" + .giteaOwner + "\t" + .giteaRepo + "\t" + (.defaultBranch // "master"))' \
                  | while IFS=$'\t' read -r slug owner repo branch; do
                      [ -n "${slug}" ] || continue
                      [ -n "${owner}" ] || continue
                      [ -n "${repo}" ] || continue
                      dest="${workspace_root}/${slug}"
                      sync_repo "${slug}" "${owner}" "${repo}" "${branch}" "${dest}"
                    done

                echo "${export_json}" \
                  | jq -r '
                      [
                        .users[]?,
                        (.projects[]?.createdBy // ""),
                        (.projects[]?.owners[]? // ""),
                        (.projects[]?.editors[]? // ""),
                        (.projects[]?.viewers[]? // "")
                      ]
                      | map(ascii_downcase)
                      | map(select(test("^[a-zA-Z0-9_.@-]+$")))
                      | unique
                      | .[]
                    ' \
                  | while read -r username; do
                      [ -n "${username}" ] || continue
                      user_dir="${user_root}/${username}"
                      mkdir -p "${user_dir}"
                      ensure_user_scaffold "${user_dir}" "${username}"
                      sync_user_s3 "${username}" "${user_dir}"

              echo "${export_json}" \
                | jq -r --arg u "${username}" '
                    .projects[]?
                    | select(
                        ((.createdBy // "" | ascii_downcase) == $u)
                        or ((.owners // [] | map(ascii_downcase) | index($u)) != null)
                        or ((.editors // [] | map(ascii_downcase) | index($u)) != null)
                        or ((.viewers // [] | map(ascii_downcase) | index($u)) != null)
                      )
                    | (.slug + "\t" + .giteaOwner + "\t" + .giteaRepo + "\t" + (.defaultBranch // "master"))
                  ' \
                | while IFS=$'\t' read -r slug owner repo branch; do
                    [ -n "${slug}" ] || continue
                    [ -n "${owner}" ] || continue
                    [ -n "${repo}" ] || continue
                            dest="${user_dir}/${slug}"
                            sync_repo "${slug}" "${owner}" "${repo}" "${branch}" "${dest}"
                    done
                    done

                sync_public_repos

                sleep "${interval}"
              done
          command:
            - /bin/sh
            - -lc
          env:
            - name: SKYFORGE_WORKSPACE_SYNC_INTERVAL
              value: "60"
            - name: SKYFORGE_OBJECT_STORAGE_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_OBJECT_STORAGE_ENDPOINT
            - name: SKYFORGE_OBJECT_STORAGE_USE_SSL
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_OBJECT_STORAGE_USE_SSL
            - name: SKYFORGE_WORKSPACE_S3_BUCKET
              value: "skyforge-files"
          image: alpine:3.20
          name: code-workspace-sync
          volumeMounts:
            - mountPath: /workspace
              name: shared-workspace
            - mountPath: /run/secrets
              name: run-secrets
              readOnly: true
      restartPolicy: Always
      volumes:
        - name: shared-workspace
          persistentVolumeClaim:
            claimName: shared-workspace
        - name: run-secrets
          projected:
            sources:
              - secret:
                  items:
                    - key: skyforge-internal-token
                      path: skyforge-internal-token
                  name: skyforge-internal-token
                  optional: true
              - secret:
                  items:
                    - key: password
                      path: skyforge-admin-shared
                  name: skyforge-admin-shared
              - secret:
                  items:
                    - key: object-storage-artifacts-access-key
                      path: object-storage-artifacts-access-key
                  name: object-storage-artifacts-access-key
                  optional: true
              - secret:
                  items:
                    - key: object-storage-artifacts-secret-key
                      path: object-storage-artifacts-secret-key
                  name: object-storage-artifacts-secret-key
                  optional: true
              - secret:
                  items:
                    - key: object-storage-root-user
                      path: object-storage-root-user
                  name: object-storage-root-user
                  optional: true
              - secret:
                  items:
                    - key: object-storage-root-password
                      path: object-storage-root-password
                  name: object-storage-root-password
                  optional: true

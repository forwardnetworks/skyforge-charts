apiVersion: v1
kind: ConfigMap
metadata:
  name: skyforge-migrate-config
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
data:
  atlas.hcl: |
    variable "db_url" {
      type = string
    }
    
    env "prod" {
      url = var.db_url
      migration {
        dir    = "file:///app/skyforge/migrations"
        format = golang-migrate
      }
      format {
        migrate {
          diff = "{{ sql . \"  \" }}"
        }
      }
    }
  atlas.sum: |
    h1:kjBWkFLzyKp/+yBe4yiLe8T9LThWR55J+w4jIAn1vDk=
    20251220000100_init.up.sql h1:ZR4Y0ICXFcjlVW2XKzVYoSNksZP2tQ0ajHHNnh/1IoM=
    20251221000100_cloud_credentials.up.sql h1:Xb5agfyv110UYW/49J7WKrDhUCDZeS7EiMKgQUf+Tvs=
    20251222000100_project_visibility.up.sql h1:PDVyAxeOyGa1iSj+KXN2dlV1G2jxBK9A49c/1gXv4PQ=
    20251223000100_governance_tables.up.sql h1:I/yixR+WfszaYbqb/MmWNmv88qAbdG22eUQ747NHX7M=
    20251223000200_deployments.up.sql h1:AatWT1CH2r72NBhtjBLtwZh9dwFSmFdhT5W0sLjv5LI=
    20251224000100_labpp_templates.up.sql h1:L6XkOdaN6+IRWScLYshgzEeZ7+VCP2aKfcOBK6/nEZY=
    20251227000100_deployments_labpp.up.sql h1:Hx69mqydHuLCmo0bNdXU2ZpN+JHFrIIpqihc7+Rk1ZU=
    20251229000100_dns_tokens.up.sql h1:S1XoLnrVGFxTKpYKM1/yn+tmu5+1KFv1IEXdI5bXyfA=
    20251230000100_syslog_events.up.sql h1:XeWauMZmv3WMFSji3JjbweiRS01dm2gVj9ZV5DlDp2I=
    20251230000200_webhooks_snmp.up.sql h1:HIKuQsWzqF0MKIILCvDttMDcHm8JF1Uj0qfqMiJLis0=
    20251231000100_containerlab_templates.up.sql h1:YM/yZEczDuH9siqBXsV583AlTEpfQxcT2pVVZSgw+Ng=
    20260101000100_pki_certs.up.sql h1:pKe9+RM8Ne6BkLRpOMO46Xdk6vCJKbofbY3imsfrkcA=
    20260102000100_tasks.up.sql h1:eTgJzGd9RbxatsBg3/DPkbVPt6DCLHurhuV5DA3ieho=
    20260102000200_variable_groups.up.sql h1:rP1btq+GLuCt2cEmVOBil2r2pdebT9HriVL/GuOcK/E=
    20260102000400_forward_credentials.up.sql h1:K7UN4IdF8Ag0PevZr+QSq2P38YKDyy91fASLOGOO42A=
    20260102000500_forward_collectors.up.sql h1:XpO8ZLkT7WzV6W9dAKqFGdxQL209nlIT0RxmSLGkiHs=
    20260102000600_pki_ssh_certs.up.sql h1:HuOwauibGEjWiJWF9oEMNkai+769epYXAPEQ7epAQ3Y=
    20260103000100_workspace_rename.up.sql h1:q4ttxNo49clCFnVEaNuG41ll/k0qKB/0YKK+pQXZcbQ=
    20260110120000_rename_tofu_to_terraform.up.sql h1:/dic8pIb/fzn8TB3EHeqyJ8TgOupH2Jh1sR4OOWGc7Y=
    20260112000100_task_events.up.sql h1:Z0dqhyzNJPZ8Yc4OiItZMzXew4SyvypbJs0tnuB0RcA=
    20260113000300_forward_device_types.up.sql h1:JarGi+wuj19+n8psqqMrlzG1TszihzGyi4l9M96vM/g=
    20260114000100_node_metrics_and_heartbeats.up.sql h1:+7obkIGiRcr+Hj83T2NhSg3Q085I3jc9WZ/MDfFJX94=
    20260114000200_ldap_password_cache.up.sql h1:ys4afLQq7BMNQJbdSqXICIt5WNAT6CPAfvFYPUxtrgM=
    20260114000300_workspace_servers.up.sql h1:uBAK5cw6LBEZEVPyxPDIa+hFcnEaiB58FvmUvDRnEHI=
    20260115000100_drop_legacy_workspace_id.up.sql h1:7+6zoX6ehQAWQuZdZbvGupvYwBb2nanCe4YqlvNDNzs=
    20260115000200_workspace_template_sources.up.sql h1:Uv9/hpAykCGV2KaULmMVLMfX53MejVN/56TyG5i7I30=
    20260116000100_task_priority.up.sql h1:wD7K3qPn1iblIWofEy3swTbKjtkT19g8nN7x0WGOtKU=
  20251220000100_init.up.sql: |
    CREATE TABLE sf_users (
      username text PRIMARY KEY,
      display_name text,
      email text,
      created_at timestamptz NOT NULL DEFAULT now(),
      last_seen_at timestamptz
    );
    
    CREATE TABLE sf_projects (
      id text PRIMARY KEY,
      slug text NOT NULL UNIQUE,
      name text NOT NULL,
      description text,
      created_at timestamptz NOT NULL DEFAULT now(),
      created_by text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      blueprint text,
      default_branch text,
      terraform_state_key text,
      terraform_init_template_id integer,
      terraform_plan_template_id integer,
      terraform_apply_template_id integer,
      ansible_run_template_id integer,
      netlab_run_template_id integer,
      aws_account_id text,
      aws_role_name text,
      aws_region text,
      aws_auth_method text,
      artifacts_bucket text,
      eve_server text,
      netlab_server text,
      legacy_project_id integer NOT NULL,
      gitea_owner text NOT NULL,
      gitea_repo text NOT NULL,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE INDEX sf_projects_created_by_idx ON sf_projects(created_by);
    
    CREATE TABLE sf_project_members (
      project_id text NOT NULL REFERENCES sf_projects(id) ON DELETE CASCADE,
      username text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      role text NOT NULL CHECK (role IN ('owner','editor','viewer')),
      granted_at timestamptz NOT NULL DEFAULT now(),
      PRIMARY KEY (project_id, username)
    );
    
    CREATE INDEX sf_project_members_user_idx ON sf_project_members(username);
    
    CREATE TABLE sf_project_groups (
      project_id text NOT NULL REFERENCES sf_projects(id) ON DELETE CASCADE,
      group_name text NOT NULL,
      role text NOT NULL CHECK (role IN ('owner','editor','viewer')),
      granted_at timestamptz NOT NULL DEFAULT now(),
      PRIMARY KEY (project_id, group_name)
    );
    
    CREATE INDEX sf_project_groups_project_idx ON sf_project_groups(project_id);
    
    CREATE TABLE sf_aws_sso_tokens (
      username text PRIMARY KEY,
      start_url text NOT NULL,
      region text NOT NULL,
      client_id text,
      client_secret text,
      client_secret_expires_at timestamptz,
      access_token text,
      access_token_expires_at timestamptz,
      refresh_token text,
      refresh_token_expires_at timestamptz,
      last_authenticated_at_utc timestamptz,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE TABLE sf_project_aws_static_credentials (
      project_id text PRIMARY KEY REFERENCES sf_projects(id) ON DELETE CASCADE,
      access_key_id text NOT NULL,
      secret_access_key text NOT NULL,
      session_token text,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE TABLE sf_audit_log (
      id bigserial PRIMARY KEY,
      created_at timestamptz NOT NULL DEFAULT now(),
      actor_username text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      actor_is_admin boolean NOT NULL DEFAULT false,
      impersonated_username text,
      action text NOT NULL,
      project_id text REFERENCES sf_projects(id) ON DELETE SET NULL,
      details text
    );
    
    CREATE INDEX sf_audit_log_created_at_idx ON sf_audit_log(created_at DESC);
    CREATE INDEX sf_audit_log_actor_idx ON sf_audit_log(actor_username);
    
    CREATE TABLE sf_notifications (
      id uuid PRIMARY KEY,
      username text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      title text NOT NULL,
      message text,
      type text NOT NULL,
      category text,
      reference_id text,
      priority text,
      is_read boolean NOT NULL DEFAULT false,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE INDEX sf_notifications_user_idx ON sf_notifications(username, created_at DESC);
    
    CREATE TABLE sf_settings (
      key text PRIMARY KEY,
      value text NOT NULL,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now()
    );
  20251221000100_cloud_credentials.up.sql: |
    CREATE TABLE sf_project_azure_credentials (
      project_id text PRIMARY KEY REFERENCES sf_projects(id) ON DELETE CASCADE,
      tenant_id text NOT NULL,
      client_id text NOT NULL,
      client_secret text NOT NULL,
      subscription_id text,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE TABLE sf_project_gcp_credentials (
      project_id text PRIMARY KEY REFERENCES sf_projects(id) ON DELETE CASCADE,
      service_account_json text NOT NULL,
      project_id_override text,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
  20251222000100_project_visibility.up.sql: |
    ALTER TABLE sf_projects
      ADD COLUMN IF NOT EXISTS is_public boolean NOT NULL DEFAULT false;
  20251223000100_governance_tables.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_resources (
      id uuid PRIMARY KEY,
      provider text NOT NULL,
      resource_id text NOT NULL,
      resource_type text NOT NULL,
      project_id text REFERENCES sf_projects(id) ON DELETE SET NULL,
      name text,
      region text,
      account_id text,
      owner_username text REFERENCES sf_users(username) ON UPDATE CASCADE,
      status text,
      tags jsonb NOT NULL DEFAULT '{}'::jsonb,
      metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
      first_seen timestamptz NOT NULL DEFAULT now(),
      last_seen timestamptz NOT NULL DEFAULT now(),
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE UNIQUE INDEX IF NOT EXISTS sf_resources_provider_uq ON sf_resources(provider, resource_id);
    CREATE INDEX IF NOT EXISTS sf_resources_project_idx ON sf_resources(project_id);
    CREATE INDEX IF NOT EXISTS sf_resources_owner_idx ON sf_resources(owner_username);
    
    CREATE TABLE IF NOT EXISTS sf_resource_events (
      id uuid PRIMARY KEY,
      resource_id uuid REFERENCES sf_resources(id) ON DELETE CASCADE,
      event_type text NOT NULL,
      actor_username text REFERENCES sf_users(username) ON UPDATE CASCADE,
      actor_is_admin boolean NOT NULL DEFAULT false,
      impersonated_username text,
      project_id text REFERENCES sf_projects(id) ON DELETE SET NULL,
      details jsonb NOT NULL DEFAULT '{}'::jsonb,
      created_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE INDEX IF NOT EXISTS sf_resource_events_resource_idx ON sf_resource_events(resource_id, created_at DESC);
    CREATE INDEX IF NOT EXISTS sf_resource_events_project_idx ON sf_resource_events(project_id, created_at DESC);
    
    CREATE TABLE IF NOT EXISTS sf_cost_snapshots (
      id uuid PRIMARY KEY,
      resource_id uuid REFERENCES sf_resources(id) ON DELETE SET NULL,
      project_id text REFERENCES sf_projects(id) ON DELETE SET NULL,
      provider text NOT NULL,
      period_start date NOT NULL,
      period_end date NOT NULL,
      cost_amount numeric NOT NULL,
      cost_currency text NOT NULL DEFAULT 'USD',
      source text,
      metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
      created_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE INDEX IF NOT EXISTS sf_cost_snapshots_project_idx ON sf_cost_snapshots(project_id, period_end DESC);
    CREATE INDEX IF NOT EXISTS sf_cost_snapshots_provider_idx ON sf_cost_snapshots(provider, period_end DESC);
    
    CREATE TABLE IF NOT EXISTS sf_usage_snapshots (
      id uuid PRIMARY KEY,
      project_id text REFERENCES sf_projects(id) ON DELETE SET NULL,
      provider text NOT NULL,
      scope_type text NOT NULL,
      scope_id text,
      metric text NOT NULL,
      value numeric NOT NULL,
      unit text,
      metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
      collected_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE INDEX IF NOT EXISTS sf_usage_snapshots_project_idx ON sf_usage_snapshots(project_id, collected_at DESC);
    CREATE INDEX IF NOT EXISTS sf_usage_snapshots_provider_idx ON sf_usage_snapshots(provider, collected_at DESC);
  20251223000200_deployments.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_deployments (
      id uuid PRIMARY KEY,
      project_id text NOT NULL REFERENCES sf_projects(id) ON DELETE CASCADE,
      name text NOT NULL,
      type text NOT NULL CHECK (type IN ('terraform','netlab')),
      config jsonb NOT NULL DEFAULT '{}'::jsonb,
      created_by text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now(),
      last_task_project_id integer,
      last_task_id integer,
      last_status text,
      last_started_at timestamptz,
      last_finished_at timestamptz
    );
    
    CREATE UNIQUE INDEX IF NOT EXISTS sf_deployments_project_name_uq ON sf_deployments(project_id, name);
    CREATE INDEX IF NOT EXISTS sf_deployments_project_idx ON sf_deployments(project_id, updated_at DESC);
  20251224000100_labpp_templates.up.sql: |
    ALTER TABLE sf_projects ADD COLUMN labpp_run_template_id integer;
  20251227000100_deployments_labpp.up.sql: |
    ALTER TABLE sf_deployments
      DROP CONSTRAINT IF EXISTS sf_deployments_type_check;
    
    ALTER TABLE sf_deployments
      ADD CONSTRAINT sf_deployments_type_check CHECK (type IN ('terraform','netlab','labpp'));
  20251229000100_dns_tokens.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_dns_tokens (
      username text PRIMARY KEY REFERENCES sf_users(username) ON UPDATE CASCADE,
      token text NOT NULL,
      zone text NOT NULL,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
  20251230000100_syslog_events.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_syslog_events (
      id bigserial PRIMARY KEY,
      received_at timestamptz NOT NULL DEFAULT now(),
      source_ip inet NOT NULL,
      hostname text,
      app_name text,
      proc_id text,
      msg_id text,
      facility integer,
      severity integer,
      message text,
      raw text NOT NULL
    );
    
    CREATE INDEX IF NOT EXISTS sf_syslog_events_received_at_idx ON sf_syslog_events(received_at DESC);
    CREATE INDEX IF NOT EXISTS sf_syslog_events_source_ip_idx ON sf_syslog_events(source_ip);
    
    CREATE TABLE IF NOT EXISTS sf_syslog_routes (
      source_cidr cidr PRIMARY KEY,
      owner_username text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      label text,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE INDEX IF NOT EXISTS sf_syslog_routes_owner_idx ON sf_syslog_routes(owner_username);
  20251230000200_webhooks_snmp.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_webhook_tokens (
      username text PRIMARY KEY REFERENCES sf_users(username) ON UPDATE CASCADE,
      token text NOT NULL,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE TABLE IF NOT EXISTS sf_webhook_events (
      id bigserial PRIMARY KEY,
      received_at timestamptz NOT NULL DEFAULT now(),
      username text REFERENCES sf_users(username) ON UPDATE CASCADE,
      token text NOT NULL,
      method text NOT NULL,
      path text NOT NULL,
      source_ip inet,
      headers_json text,
      body text
    );
    
    CREATE INDEX IF NOT EXISTS sf_webhook_events_received_at_idx ON sf_webhook_events(received_at DESC);
    CREATE INDEX IF NOT EXISTS sf_webhook_events_username_idx ON sf_webhook_events(username, received_at DESC);
    
    CREATE TABLE IF NOT EXISTS sf_snmp_trap_tokens (
      username text PRIMARY KEY REFERENCES sf_users(username) ON UPDATE CASCADE,
      community text NOT NULL,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE TABLE IF NOT EXISTS sf_snmp_trap_events (
      id bigserial PRIMARY KEY,
      received_at timestamptz NOT NULL DEFAULT now(),
      username text REFERENCES sf_users(username) ON UPDATE CASCADE,
      source_ip inet,
      community text,
      oid text,
      vars_json text,
      raw_hex text
    );
    
    CREATE INDEX IF NOT EXISTS sf_snmp_trap_events_received_at_idx ON sf_snmp_trap_events(received_at DESC);
    CREATE INDEX IF NOT EXISTS sf_snmp_trap_events_username_idx ON sf_snmp_trap_events(username, received_at DESC);
  20251231000100_containerlab_templates.up.sql: |
    ALTER TABLE sf_projects ADD COLUMN containerlab_run_template_id integer;
  20260101000100_pki_certs.up.sql: |
    CREATE TABLE sf_pki_certs (
      id text PRIMARY KEY,
      username text NOT NULL,
      project_id text REFERENCES sf_projects(id) ON DELETE SET NULL,
      common_name text NOT NULL,
      sans jsonb,
      cert_pem text NOT NULL,
      key_pem text NOT NULL,
      issued_at timestamptz NOT NULL DEFAULT now(),
      expires_at timestamptz NOT NULL,
      revoked_at timestamptz
    );
    
    CREATE INDEX sf_pki_certs_user_idx ON sf_pki_certs(username, issued_at DESC);
    CREATE INDEX sf_pki_certs_project_idx ON sf_pki_certs(project_id);
  20260102000100_tasks.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_tasks (
      id bigserial PRIMARY KEY,
      project_id text NOT NULL REFERENCES sf_projects(id) ON DELETE CASCADE,
      deployment_id uuid,
      task_type text NOT NULL,
      status text NOT NULL,
      message text,
      metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
      created_by text NOT NULL REFERENCES sf_users(username) ON UPDATE CASCADE,
      created_at timestamptz NOT NULL DEFAULT now(),
      started_at timestamptz,
      finished_at timestamptz,
      error text
    );
    
    CREATE INDEX IF NOT EXISTS sf_tasks_project_idx ON sf_tasks(project_id, created_at DESC);
    CREATE INDEX IF NOT EXISTS sf_tasks_deployment_idx ON sf_tasks(deployment_id, created_at DESC);
    
    CREATE TABLE IF NOT EXISTS sf_task_logs (
      id bigserial PRIMARY KEY,
      task_id bigint NOT NULL REFERENCES sf_tasks(id) ON DELETE CASCADE,
      created_at timestamptz NOT NULL DEFAULT now(),
      stream text NOT NULL DEFAULT 'stdout',
      output text NOT NULL
    );
    
    CREATE INDEX IF NOT EXISTS sf_task_logs_task_idx ON sf_task_logs(task_id, created_at);
  20260102000200_variable_groups.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_project_variable_groups (
      id bigserial PRIMARY KEY,
      project_id text NOT NULL REFERENCES sf_projects(id) ON DELETE CASCADE,
      name text NOT NULL,
      variables jsonb NOT NULL DEFAULT '{}'::jsonb,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    CREATE UNIQUE INDEX IF NOT EXISTS sf_project_variable_groups_name_uq ON sf_project_variable_groups(project_id, name);
    CREATE INDEX IF NOT EXISTS sf_project_variable_groups_project_idx ON sf_project_variable_groups(project_id, updated_at DESC);
  20260102000400_forward_credentials.up.sql: |
    CREATE TABLE sf_project_forward_credentials (
      project_id text PRIMARY KEY REFERENCES sf_projects(id) ON DELETE CASCADE,
      base_url text NOT NULL,
      username text NOT NULL,
      password text NOT NULL,
      device_username text,
      device_password text,
      jump_host text,
      jump_username text,
      jump_private_key text,
      jump_cert text,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
  20260102000500_forward_collectors.up.sql: |
    ALTER TABLE sf_project_forward_credentials
      ADD COLUMN collector_id text,
      ADD COLUMN collector_username text;
  20260102000600_pki_ssh_certs.up.sql: |
    CREATE TABLE sf_pki_ssh_certs (
      id TEXT PRIMARY KEY,
      username TEXT NOT NULL,
      project_id TEXT NULL,
      principals JSONB NOT NULL,
      public_key TEXT NOT NULL,
      cert TEXT NOT NULL,
      key_pem TEXT NOT NULL,
      issued_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      expires_at TIMESTAMPTZ NOT NULL,
      revoked_at TIMESTAMPTZ NULL
    );
    
    CREATE INDEX sf_pki_ssh_certs_user_idx ON sf_pki_ssh_certs(username, issued_at DESC);
    CREATE INDEX sf_pki_ssh_certs_project_idx ON sf_pki_ssh_certs(project_id);
  20260103000100_workspace_rename.up.sql: |
    ALTER TABLE sf_projects RENAME TO sf_workspaces;
    ALTER TABLE sf_workspaces RENAME COLUMN legacy_project_id TO legacy_workspace_id;
    
    ALTER TABLE sf_project_members RENAME TO sf_workspace_members;
    ALTER TABLE sf_workspace_members RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_project_groups RENAME TO sf_workspace_groups;
    ALTER TABLE sf_workspace_groups RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_project_aws_static_credentials RENAME TO sf_workspace_aws_static_credentials;
    ALTER TABLE sf_workspace_aws_static_credentials RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_project_azure_credentials RENAME TO sf_workspace_azure_credentials;
    ALTER TABLE sf_workspace_azure_credentials RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_project_gcp_credentials RENAME TO sf_workspace_gcp_credentials;
    ALTER TABLE sf_workspace_gcp_credentials RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_project_forward_credentials RENAME TO sf_workspace_forward_credentials;
    ALTER TABLE sf_workspace_forward_credentials RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_project_variable_groups RENAME TO sf_workspace_variable_groups;
    ALTER TABLE sf_workspace_variable_groups RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_deployments RENAME COLUMN project_id TO workspace_id;
    ALTER TABLE sf_deployments RENAME COLUMN last_task_project_id TO last_task_workspace_id;
    
    ALTER TABLE sf_tasks RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_resources RENAME COLUMN project_id TO workspace_id;
    ALTER TABLE sf_resource_events RENAME COLUMN project_id TO workspace_id;
    ALTER TABLE sf_cost_snapshots RENAME COLUMN project_id TO workspace_id;
    ALTER TABLE sf_usage_snapshots RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_pki_certs RENAME COLUMN project_id TO workspace_id;
    ALTER TABLE sf_pki_ssh_certs RENAME COLUMN project_id TO workspace_id;
    
    ALTER TABLE sf_audit_log RENAME COLUMN project_id TO workspace_id;
    
    ALTER INDEX IF EXISTS sf_projects_created_by_idx RENAME TO sf_workspaces_created_by_idx;
    ALTER INDEX IF EXISTS sf_project_members_user_idx RENAME TO sf_workspace_members_user_idx;
    ALTER INDEX IF EXISTS sf_project_groups_project_idx RENAME TO sf_workspace_groups_workspace_idx;
    ALTER INDEX IF EXISTS sf_resources_project_idx RENAME TO sf_resources_workspace_idx;
    ALTER INDEX IF EXISTS sf_resource_events_project_idx RENAME TO sf_resource_events_workspace_idx;
    ALTER INDEX IF EXISTS sf_cost_snapshots_project_idx RENAME TO sf_cost_snapshots_workspace_idx;
    ALTER INDEX IF EXISTS sf_usage_snapshots_project_idx RENAME TO sf_usage_snapshots_workspace_idx;
    ALTER INDEX IF EXISTS sf_deployments_project_name_uq RENAME TO sf_deployments_workspace_name_uq;
    ALTER INDEX IF EXISTS sf_deployments_project_idx RENAME TO sf_deployments_workspace_idx;
    ALTER INDEX IF EXISTS sf_pki_certs_project_idx RENAME TO sf_pki_certs_workspace_idx;
    ALTER INDEX IF EXISTS sf_pki_ssh_certs_project_idx RENAME TO sf_pki_ssh_certs_workspace_idx;
    ALTER INDEX IF EXISTS sf_tasks_project_idx RENAME TO sf_tasks_workspace_idx;
    ALTER INDEX IF EXISTS sf_project_variable_groups_project_idx RENAME TO sf_workspace_variable_groups_workspace_idx;
    ALTER INDEX IF EXISTS sf_project_variable_groups_name_uq RENAME TO sf_workspace_variable_groups_name_uq;
  20260110120000_rename_tofu_to_terraform.up.sql: |
    DO $$
    BEGIN
      IF to_regclass('sf_projects') IS NOT NULL THEN
        BEGIN
          ALTER TABLE sf_projects RENAME COLUMN tofu_init_template_id TO terraform_init_template_id;
        EXCEPTION WHEN undefined_column THEN
          NULL;
        END;
    
        BEGIN
          ALTER TABLE sf_projects RENAME COLUMN tofu_plan_template_id TO terraform_plan_template_id;
        EXCEPTION WHEN undefined_column THEN
          NULL;
        END;
    
        BEGIN
          ALTER TABLE sf_projects RENAME COLUMN tofu_apply_template_id TO terraform_apply_template_id;
        EXCEPTION WHEN undefined_column THEN
          NULL;
        END;
      END IF;
    
      IF to_regclass('sf_workspaces') IS NOT NULL THEN
        BEGIN
          ALTER TABLE sf_workspaces RENAME COLUMN tofu_init_template_id TO terraform_init_template_id;
        EXCEPTION WHEN undefined_column THEN
          NULL;
        END;
    
        BEGIN
          ALTER TABLE sf_workspaces RENAME COLUMN tofu_plan_template_id TO terraform_plan_template_id;
        EXCEPTION WHEN undefined_column THEN
          NULL;
        END;
    
        BEGIN
          ALTER TABLE sf_workspaces RENAME COLUMN tofu_apply_template_id TO terraform_apply_template_id;
        EXCEPTION WHEN undefined_column THEN
          NULL;
        END;
      END IF;
    END $$;
    
    UPDATE sf_deployments SET type='terraform' WHERE type='tofu';
    
    ALTER TABLE sf_deployments DROP CONSTRAINT IF EXISTS sf_deployments_type_check;
    ALTER TABLE sf_deployments ADD CONSTRAINT sf_deployments_type_check CHECK (type IN ('terraform','netlab','labpp','containerlab'));

  20260112000100_task_events.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_task_events (
      id bigserial PRIMARY KEY,
      task_id bigint NOT NULL REFERENCES sf_tasks(id) ON DELETE CASCADE,
      created_at timestamptz NOT NULL DEFAULT now(),
      event_type text NOT NULL,
      payload jsonb NOT NULL DEFAULT '{}'::jsonb
    );
    
    CREATE INDEX IF NOT EXISTS sf_task_events_task_idx ON sf_task_events(task_id, id);

  20260113000300_forward_device_types.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_forward_device_types (
      device_key text PRIMARY KEY,
      forward_type text NOT NULL,
      updated_at timestamptz NOT NULL DEFAULT now()
    );
    
    -- Seed a few high-value defaults. Users/admin tooling can add/update mappings later.
    INSERT INTO sf_forward_device_types (device_key, forward_type)
    VALUES
      ('linux', 'linux_os_ssh'),
      ('eos', 'arista_eos_ssh')
    ON CONFLICT (device_key) DO NOTHING;

  20260114000100_node_metrics_and_heartbeats.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_node_metric_snapshots (
      node TEXT NOT NULL,
      metric_name TEXT NOT NULL,
      updated_at TIMESTAMPTZ NOT NULL,
      metric_json JSONB NOT NULL,
      PRIMARY KEY (node, metric_name)
    );
    
    CREATE INDEX IF NOT EXISTS idx_sf_node_metric_snapshots_updated_at
      ON sf_node_metric_snapshots (updated_at DESC);
    
    CREATE TABLE IF NOT EXISTS sf_taskworker_heartbeats (
      instance TEXT PRIMARY KEY,
      last_seen TIMESTAMPTZ NOT NULL
    );
    
    CREATE INDEX IF NOT EXISTS idx_sf_taskworker_heartbeats_last_seen
      ON sf_taskworker_heartbeats (last_seen DESC);

  20260114000200_ldap_password_cache.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_ldap_password_cache (
      username TEXT PRIMARY KEY,
      encrypted_password TEXT NOT NULL,
      expires_at TIMESTAMPTZ NOT NULL,
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );
    
    CREATE INDEX IF NOT EXISTS idx_sf_ldap_password_cache_expires_at
      ON sf_ldap_password_cache (expires_at DESC);

  20260114000300_workspace_servers.up.sql: |
    CREATE TABLE IF NOT EXISTS sf_project_eve_servers (
      id uuid PRIMARY KEY,
      project_id text NOT NULL REFERENCES sf_workspaces(id) ON DELETE CASCADE,
      name text NOT NULL,
      api_url text NOT NULL,
      web_url text,
      skip_tls_verify boolean NOT NULL DEFAULT false,
      ssh_host text,
      ssh_user text,
      ssh_key text,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now(),
      UNIQUE (project_id, name)
    );
    
    CREATE INDEX IF NOT EXISTS sf_project_eve_servers_project_idx ON sf_project_eve_servers(project_id);
    
    CREATE TABLE IF NOT EXISTS sf_project_netlab_servers (
      id uuid PRIMARY KEY,
      project_id text NOT NULL REFERENCES sf_workspaces(id) ON DELETE CASCADE,
      name text NOT NULL,
      api_url text NOT NULL,
      api_insecure boolean NOT NULL DEFAULT true,
      api_token text,
      created_at timestamptz NOT NULL DEFAULT now(),
      updated_at timestamptz NOT NULL DEFAULT now(),
      UNIQUE (project_id, name)
    );
    
    CREATE INDEX IF NOT EXISTS sf_project_netlab_servers_project_idx ON sf_project_netlab_servers(project_id);

  20260115000100_drop_legacy_workspace_id.up.sql: |
    ALTER TABLE sf_workspaces DROP COLUMN IF EXISTS legacy_workspace_id;

  20260115000200_workspace_template_sources.up.sql: |
    ALTER TABLE sf_workspaces
      ADD COLUMN IF NOT EXISTS allow_external_template_repos boolean NOT NULL DEFAULT false;
    
    ALTER TABLE sf_workspaces
      ADD COLUMN IF NOT EXISTS allow_custom_eve_servers boolean NOT NULL DEFAULT false;
    
    ALTER TABLE sf_workspaces
      ADD COLUMN IF NOT EXISTS allow_custom_netlab_servers boolean NOT NULL DEFAULT false;
    
    ALTER TABLE sf_workspaces
      ADD COLUMN IF NOT EXISTS external_template_repos jsonb NOT NULL DEFAULT '[]'::jsonb;

  20260116000100_task_priority.up.sql: |
    ALTER TABLE sf_tasks
      ADD COLUMN IF NOT EXISTS priority integer NOT NULL DEFAULT 0;
    
    -- Optimized queue scans for oldest/highest-priority tasks.
    CREATE INDEX IF NOT EXISTS sf_tasks_queue_idx
      ON sf_tasks (workspace_id, status, priority DESC, id);
    
    CREATE INDEX IF NOT EXISTS sf_tasks_queue_deployment_idx
      ON sf_tasks (workspace_id, deployment_id, status, priority DESC, id);

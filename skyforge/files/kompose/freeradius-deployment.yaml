apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    io.kompose.service: freeradius
  name: freeradius
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: freeradius
  template:
    metadata:
      labels:
        io.kompose.service: freeradius
    spec:
      automountServiceAccountToken: false
      containers:
        - name: freeradius
          image: freeradius/freeradius-server:3.2.5
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -lc
            - |
              set -e
              export LDAP_URL="$(cat /run/secrets/skyforge-ldap-url)"
              export LDAP_BIND_DN="$(cat /run/secrets/semaphore-ldap-binddn)"
              export LDAP_BIND_PASSWORD="$(cat /run/secrets/semaphore-ldap-bindpassword)"
              export LDAP_SEARCH_DN="$(cat /run/secrets/semaphore-ldap-searchdn)"
              export LDAP_SEARCH_FILTER="$(cat /run/secrets/semaphore-ldap-searchfilter)"
              cat > /etc/raddb/mods-enabled/ldap <<EOF
              ldap {
                server = "${LDAP_URL}"
                identity = "${LDAP_BIND_DN}"
                password = "${LDAP_BIND_PASSWORD}"
                base_dn = "${LDAP_SEARCH_DN}"
                filter = "${LDAP_SEARCH_FILTER}"
                start_tls = no
                tls {
                  start_tls = no
                  require_cert = "never"
                }
                user {
                  filter = "${LDAP_SEARCH_FILTER}"
                }
              }
              EOF
              awk '/authorize \\{/{print; print "    ldap"; next}1' /etc/raddb/sites-enabled/default > /tmp/default
              mv /tmp/default /etc/raddb/sites-enabled/default
              awk '/authenticate \\{/{print; print "    Auth-Type LDAP {"; print "      ldap"; print "    }"; next}1' /etc/raddb/sites-enabled/default > /tmp/default
              mv /tmp/default /etc/raddb/sites-enabled/default
              exec freeradius -f
          ports:
            - containerPort: 1812
              protocol: UDP
            - containerPort: 1813
              protocol: UDP
          volumeMounts:
            - name: run-secrets
              mountPath: /run/secrets
              readOnly: true
      volumes:
        - name: run-secrets
          projected:
            sources:
              - secret:
                  name: skyforge-ldap-url
                  items:
                    - key: skyforge-ldap-url
                      path: skyforge-ldap-url
              - secret:
                  name: semaphore-ldap-binddn
                  items:
                    - key: semaphore-ldap-binddn
                      path: semaphore-ldap-binddn
              - secret:
                  name: semaphore-ldap-bindpassword
                  items:
                    - key: semaphore-ldap-bindpassword
                      path: semaphore-ldap-bindpassword
              - secret:
                  name: semaphore-ldap-searchdn
                  items:
                    - key: semaphore-ldap-searchdn
                      path: semaphore-ldap-searchdn
              - secret:
                  name: semaphore-ldap-searchfilter
                  items:
                    - key: semaphore-ldap-searchfilter
                      path: semaphore-ldap-searchfilter

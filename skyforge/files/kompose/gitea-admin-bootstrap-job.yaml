apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: "12"
  labels:
    io.kompose.service: gitea-admin-bootstrap
  name: gitea-admin-bootstrap
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        io.kompose.service: gitea-admin-bootstrap
    spec:
      automountServiceAccountToken: false
      enableServiceLinks: false
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  io.kompose.service: gitea
              topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      containers:
        - args:
            - |
              set -eu
              export SECRET_KEY="$(cat /run/secrets/gitea-secret-key)"
              export GITEA__database__PASSWD="$(cat /run/secrets/db-gitea-password)"
              admin_username="${SKYFORGE_ADMIN_USERNAME:-}"
              admin_email="${SKYFORGE_ADMIN_EMAIL:-}"
              admin_password="$(cat /run/secrets/skyforge-admin-shared | tr -d '\n')"
              config="/var/lib/gitea/custom/conf/app.ini"

              # Wait for Gitea to write its config file so the CLI commands work on fresh installs.
              for i in $(seq 1 60); do
                if [ -f "${config}" ]; then
                  break
                fi
                echo "Waiting for gitea config to exist at ${config} (${i}/60)..."
                sleep 2
              done

              if [ ! -f "${config}" ]; then
                echo "Gitea config not found at ${config}; skipping admin bootstrap."
                exit 0
              fi

              if [ -z "${admin_username}" ] || [ -z "${admin_password}" ]; then
                echo "SKYFORGE admin username/password not set; skipping."
                exit 0
              fi

              if gitea admin user create --config "${config}" \
                --username "${admin_username}" \
                --password "${admin_password}" \
                --email "${admin_email}" \
                --admin \
                --must-change-password=false; then
                echo "Gitea admin created: ${admin_username}"
              else
                gitea admin user change-password --config "${config}" \
                  --username "${admin_username}" \
                  --password "${admin_password}" \
                  --must-change-password=false
                echo "Gitea admin password updated: ${admin_username}"
              fi

              gitea admin user must-change-password --config "${config}" --all --unset

          command:
            - /bin/sh
            - -c
          env:
            - name: SKYFORGE_ADMIN_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_USERNAME
            - name: SKYFORGE_ADMIN_EMAIL
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_EMAIL
          image: ghcr.io/go-gitea/gitea:1.24.6-rootless
          name: gitea-admin-bootstrap
          securityContext:
            runAsGroup: 1000
            runAsUser: 1000
          volumeMounts:
            - mountPath: /run/secrets
              name: run-secrets
              readOnly: true
            - mountPath: /var/lib/gitea
              name: gitea-data
      restartPolicy: OnFailure
      volumes:
        - name: run-secrets
          projected:
            sources:
              - secret:
                  items:
                    - key: db-gitea-password
                      path: db-gitea-password
                  name: db-gitea-password
              - secret:
                  items:
                    - key: gitea-secret-key
                      path: gitea-secret-key
                  name: gitea-secret-key
              - secret:
                  items:
                    - key: password
                      path: skyforge-admin-shared
                  name: skyforge-admin-shared
        - name: gitea-data
          persistentVolumeClaim:
            claimName: gitea-data

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    io.kompose.service: semaphore
  name: semaphore
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: semaphore
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        io.kompose.service: semaphore
    spec:
      automountServiceAccountToken: false
      serviceAccountName: semaphore-runner
      enableServiceLinks: false
      containers:
        - args:
            - |
              set -e

              if ! command -v ansible-playbook >/dev/null 2>&1; then
                apk add --no-cache ansible >/dev/null
              fi
              pkgs=""
              if ! command -v bash >/dev/null 2>&1; then pkgs="${pkgs} bash"; fi
              if ! command -v python3 >/dev/null 2>&1; then pkgs="${pkgs} python3"; fi
              if ! command -v unzip >/dev/null 2>&1; then pkgs="${pkgs} unzip"; fi
              if ! command -v mc >/dev/null 2>&1; then pkgs="${pkgs} minio-client"; fi
              if ! command -v kubectl >/dev/null 2>&1; then pkgs="${pkgs} kubectl"; fi
              if ! command -v ssh >/dev/null 2>&1; then pkgs="${pkgs} openssh-client"; fi
              if ! command -v sshpass >/dev/null 2>&1; then pkgs="${pkgs} sshpass"; fi
              if [ -n "${pkgs}" ]; then
                apk add --no-cache ${pkgs} >/dev/null
              fi

              SEMAPHORE_DB_HOST="${SEMAPHORE_DB_HOST:-db}"
              SEMAPHORE_DB_PORT="${SEMAPHORE_DB_PORT:-5432}"
              SEMAPHORE_DB_USER="${SEMAPHORE_DB_USER:-semaphore}"
              SEMAPHORE_DB="${SEMAPHORE_DB:-semaphore}"
              SEMAPHORE_WEB_ROOT="${SEMAPHORE_WEB_ROOT:-/semaphore}"
              SEMAPHORE_LDAP_ENABLE="${SEMAPHORE_LDAP_ENABLE:-true}"

              SEMAPHORE_DB_PASS="$(cat /run/secrets/db-semaphore-password)"
              SEMAPHORE_ADMIN_PASSWORD="$(cat /run/secrets/semaphore-admin-password)"
              SEMAPHORE_PROVISIONER_PASSWORD="$(cat /run/secrets/semaphore-provisioner-password)"
              SEMAPHORE_COOKIE_HASH="$(cat /run/secrets/semaphore-cookie-hash)"
              SEMAPHORE_COOKIE_ENCRYPTION="$(cat /run/secrets/semaphore-cookie-encryption)"
              SEMAPHORE_ACCESS_KEY_ENCRYPTION="$(cat /run/secrets/semaphore-access-key-encryption)"
              SEMAPHORE_LDAP_BINDDN="$(cat /run/secrets/semaphore-ldap-binddn)"
              SEMAPHORE_LDAP_BINDPASSWORD="$(cat /run/secrets/semaphore-ldap-bindpassword)"
              SEMAPHORE_LDAP_SERVER="$(cat /run/secrets/semaphore-ldap-server)"
              SEMAPHORE_LDAP_SEARCHDN="$(cat /run/secrets/semaphore-ldap-searchdn)"
              SEMAPHORE_LDAP_SEARCHFILTER="$(cat /run/secrets/semaphore-ldap-searchfilter)"
              SEMAPHORE_LDAP_NEEDTLS="$(cat /run/secrets/semaphore-ldap-needtls)"

              cat > /etc/semaphore/config.json <<EOF
              {
                "postgres": {
                  "host": "${SEMAPHORE_DB_HOST}:${SEMAPHORE_DB_PORT}",
                  "user": "${SEMAPHORE_DB_USER}",
                  "pass": "${SEMAPHORE_DB_PASS}",
                  "name": "${SEMAPHORE_DB}",
                  "options": { "sslmode": "disable" }
                },
                "dialect": "postgres",
                "tmp_path": "/tmp/semaphore",
                "web_host": "${SEMAPHORE_WEB_ROOT}",
                "cookie_hash": "${SEMAPHORE_COOKIE_HASH}",
                "cookie_encryption": "${SEMAPHORE_COOKIE_ENCRYPTION}",
                "access_key_encryption": "${SEMAPHORE_ACCESS_KEY_ENCRYPTION}",
                "ldap_enable": ${SEMAPHORE_LDAP_ENABLE},
                "ldap_binddn": "${SEMAPHORE_LDAP_BINDDN}",
                "ldap_bindpassword": "${SEMAPHORE_LDAP_BINDPASSWORD}",
                "ldap_server": "${SEMAPHORE_LDAP_SERVER}",
                "ldap_searchdn": "${SEMAPHORE_LDAP_SEARCHDN}",
                "ldap_searchfilter": "${SEMAPHORE_LDAP_SEARCHFILTER}",
                "ldap_needtls": ${SEMAPHORE_LDAP_NEEDTLS},
                "ldap_mappings": { "dn": "dn", "mail": "mail", "uid": "uid", "cn": "cn" }
              }
              EOF

              if [ -f /run/kube-api/token ] && [ -f /run/kube-api/ca.crt ]; then
                cat > /tmp/kubeconfig <<EOF
              apiVersion: v1
              kind: Config
              clusters:
                - name: in-cluster
                  cluster:
                    certificate-authority: /run/kube-api/ca.crt
                    server: https://kubernetes.default.svc
              contexts:
                - name: in-cluster
                  context:
                    cluster: in-cluster
                    namespace: skyforge
                    user: sa
              current-context: in-cluster
              users:
                - name: sa
                  user:
                    tokenFile: /run/kube-api/token
              EOF
                export KUBECONFIG=/tmp/kubeconfig
              fi

              export SEMAPHORE_ADMIN_PASSWORD
              export SEMAPHORE_PROVISIONER_PASSWORD
              exec /sbin/tini -- /usr/local/bin/server-wrapper
          command:
            - /bin/sh
            - -lc
          env:
            - name: AWS_PROFILE
              value: default
            - name: AWS_SDK_LOAD_CONFIG
              value: "1"
            - name: AWS_SHARED_CREDENTIALS_FILE
              value: /run/secrets/aws-terraform-shared-credentials
            - name: SEMAPHORE_ADMIN
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_USERNAME
            - name: SEMAPHORE_ADMIN_EMAIL
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_EMAIL
            - name: SEMAPHORE_ADMIN_NAME
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_NAME
            - name: SEMAPHORE_DB
              value: semaphore
            - name: SEMAPHORE_DB_DIALECT
              value: postgres
            - name: SEMAPHORE_DB_HOST
              value: db
            - name: SEMAPHORE_DB_PORT
              value: "5432"
            - name: SEMAPHORE_DB_USER
              value: semaphore
            - name: SEMAPHORE_PLAYBOOK_PATH
              value: /tmp/semaphore
            - name: SEMAPHORE_WEB_ROOT
              value: /semaphore
            - name: KUBECONFIG
              value: /tmp/kubeconfig
          image: semaphoreui/semaphore:v2.16.47-ansible2.16.5
          livenessProbe:
            httpGet:
              path: /semaphore/
              port: 3000
            failureThreshold: 6
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 2
          readinessProbe:
            httpGet:
              path: /semaphore/
              port: 3000
            failureThreshold: 3
            periodSeconds: 5
            timeoutSeconds: 2
          name: semaphore
          ports:
            - containerPort: 3000
              protocol: TCP
          resources:
            limits:
              memory: "1073741824"
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /run/secrets
              name: run-secrets
              readOnly: true
            - mountPath: /run/kube-api
              name: kube-api-access
              readOnly: true
            - mountPath: /workspace
              name: shared-workspace
            - mountPath: /tmp/semaphore
              name: semaphore-data
            - mountPath: /etc/semaphore
              name: semaphore-config
      restartPolicy: Always
      volumes:
        - name: run-secrets
          projected:
            sources:
              - secret:
                  items:
                    - key: db-semaphore-password
                      path: db-semaphore-password
                  name: db-semaphore-password
              - secret:
                  items:
                    - key: semaphore-admin-password
                      path: semaphore-admin-password
                  name: semaphore-admin-password
              - secret:
                  items:
                    - key: semaphore-provisioner-password
                      path: semaphore-provisioner-password
                  name: semaphore-provisioner-password
              - secret:
                  items:
                    - key: semaphore-cookie-hash
                      path: semaphore-cookie-hash
                  name: semaphore-cookie-hash
              - secret:
                  items:
                    - key: semaphore-cookie-encryption
                      path: semaphore-cookie-encryption
                  name: semaphore-cookie-encryption
              - secret:
                  items:
                    - key: semaphore-access-key-encryption
                      path: semaphore-access-key-encryption
                  name: semaphore-access-key-encryption
              - secret:
                  items:
                    - key: semaphore-ldap-binddn
                      path: semaphore-ldap-binddn
                  name: semaphore-ldap-binddn
              - secret:
                  items:
                    - key: semaphore-ldap-bindpassword
                      path: semaphore-ldap-bindpassword
                  name: semaphore-ldap-bindpassword
              - secret:
                  items:
                    - key: semaphore-ldap-server
                      path: semaphore-ldap-server
                  name: semaphore-ldap-server
              - secret:
                  items:
                    - key: semaphore-ldap-searchdn
                      path: semaphore-ldap-searchdn
                  name: semaphore-ldap-searchdn
              - secret:
                  items:
                    - key: semaphore-ldap-searchfilter
                      path: semaphore-ldap-searchfilter
                  name: semaphore-ldap-searchfilter
              - secret:
                  items:
                    - key: semaphore-ldap-needtls
                      path: semaphore-ldap-needtls
                  name: semaphore-ldap-needtls
              - secret:
                  items:
                    - key: aws-terraform-shared-credentials
                      path: aws-terraform-shared-credentials
                  name: aws-terraform-shared-credentials
              - secret:
                  items:
                    - key: object-storage-artifacts-access-key
                      path: object-storage-artifacts-access-key
                  name: object-storage-artifacts-access-key
                  optional: true
              - secret:
                  items:
                    - key: object-storage-artifacts-secret-key
                      path: object-storage-artifacts-secret-key
                  name: object-storage-artifacts-secret-key
                  optional: true
        - name: kube-api-access
          projected:
            sources:
              - serviceAccountToken:
                  path: token
                  expirationSeconds: 3600
              - configMap:
                  name: kube-root-ca.crt
                  items:
                    - key: ca.crt
                      path: ca.crt
        - name: shared-workspace
          persistentVolumeClaim:
            claimName: shared-workspace
        - name: semaphore-data
          persistentVolumeClaim:
            claimName: semaphore-data
        - name: semaphore-config
          persistentVolumeClaim:
            claimName: semaphore-config

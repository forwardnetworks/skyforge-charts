apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "30"
  labels:
    io.kompose.service: semaphore-admin-bootstrap
  name: semaphore-admin-bootstrap
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        io.kompose.service: semaphore-admin-bootstrap
    spec:
      automountServiceAccountToken: false
      enableServiceLinks: false
      containers:
        - args:
            - |
              set -eu
              login="${SKYFORGE_ADMIN_USERNAME:-}"
              name="${SKYFORGE_ADMIN_NAME:-${login}}"
              email="${SKYFORGE_ADMIN_EMAIL:-}"
              password="$(cat /run/secrets/skyforge-admin-shared | tr -d '\n')"

              if [ -z "${login}" ] || [ -z "${password}" ]; then
                echo "SKYFORGE admin username/password not set; skipping."
                exit 0
              fi

              echo "Waiting for Semaphore config..."
              for i in $(seq 1 60); do
                if [ -s /etc/semaphore/config.json ]; then
                  break
                fi
                sleep 1
              done

              if semaphore users list --config /etc/semaphore/config.json | awk '{print $1}' | grep -qx "${login}"; then
                semaphore users change-by-login --config /etc/semaphore/config.json \
                  --login "${login}" \
                  --name "${name}" \
                  --email "${email}" \
                  --password "${password}" \
                  --admin
              else
                semaphore users add --config /etc/semaphore/config.json \
                  --login "${login}" \
                  --name "${name}" \
                  --email "${email}" \
                  --password "${password}" \
                  --admin
              fi
          command:
            - /bin/sh
            - -c
          env:
            - name: SKYFORGE_ADMIN_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_USERNAME
            - name: SKYFORGE_ADMIN_NAME
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_NAME
            - name: SKYFORGE_ADMIN_EMAIL
              valueFrom:
                configMapKeyRef:
                  name: skyforge-config
                  key: SKYFORGE_ADMIN_EMAIL
          image: semaphoreui/semaphore:latest
          name: semaphore-admin-bootstrap
          volumeMounts:
            - mountPath: /run/secrets
              name: run-secrets
              readOnly: true
            - mountPath: /etc/semaphore
              name: semaphore-config
      restartPolicy: OnFailure
      volumes:
        - name: run-secrets
          projected:
            sources:
              - secret:
                  items:
                    - key: password
                      path: skyforge-admin-shared
                  name: skyforge-admin-shared
        - name: semaphore-config
          persistentVolumeClaim:
            claimName: semaphore-config

apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: skyforge-public
spec:
  entryPoints:
    - websecure
  tls:
    secretName: proxy-tls
  routes:
    - match: PathPrefix(`/git/assets/`) || PathPrefix(`/git/avatars/`) || Path(`/git/favicon.svg`)
      kind: Rule
      priority: 520
      services:
        - name: gitea
          port: 3000
      middlewares:
        - name: strip-git
    - match: PathPrefix(`/git/skyforge/blueprints`)
      kind: Rule
      priority: 510
      services:
        - name: gitea
          port: 3000
      middlewares:
        - name: strip-git
    - match: PathPrefix(`/assets/`)
      kind: Rule
      priority: 440
      services:
        - name: coder
          port: 7080
    - match: PathPrefix(`/bin/`)
      kind: Rule
      priority: 441
      services:
        - name: coder
          port: 7080
    - match: Path(`/healthz`) || Path(`/health`)
      kind: Rule
      priority: 400
      services:
        - name: skyforge-server
          port: 8085
    - match: PathPrefix(`/netbox/logout`)
      kind: Rule
      priority: 300
      services:
        - name: skyforge-logout
          port: 8080
    - match: PathPrefix(`/nautobot/logout`)
      kind: Rule
      priority: 300
      services:
        - name: skyforge-logout
          port: 8080
    - match: PathPrefix(`/files/`)
      kind: Rule
      services:
        - name: minio
          port: 9000
      middlewares:
        - name: replace-files
    - match: PathPrefix(`/assets/skyforge/`)
      kind: Rule
      priority: 450
      services:
        - name: skyforge-portal
          port: 3000
    - match: PathPrefix(`/data/`)
      kind: Rule
      services:
        - name: skyforge-server
          port: 8085
    - match: PathPrefix(`/api/skyforge/`)
      kind: Rule
      priority: 500
      services:
        - name: skyforge-server
          port: 8085
      middlewares:
        - name: replace-skyforge-api
    - match: PathPrefix(`/coder`)
      kind: Rule
      priority: 460
      services:
        - name: skyforge-portal
          port: 3000
      middlewares:
        - name: coder-portal-redirect
    - match: PathPrefix(`/workspaces`) || PathPrefix(`/templates`) || PathPrefix(`/tasks`) || PathPrefix(`/api/v2`) || PathPrefix(`/login`) || PathPrefix(`/@`) || PathPrefix(`/icon`) || PathPrefix(`/emojis`)
      kind: Rule
      priority: 455
      services:
        - name: coder
          port: 7080
    - match: PathPrefix(`/skyforge-server/`)
      kind: Rule
      services:
        - name: skyforge-server
          port: 8085
      middlewares:
        - name: replace-skyforge-server
    - match: PathPrefix(`/`)
      kind: Rule
      services:
        - name: skyforge-portal
          port: 3000
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: skyforge-authenticated
spec:
  entryPoints:
    - websecure
  tls:
    secretName: proxy-tls
  routes:
    - match: PathPrefix(`/minio-console`)
      kind: Rule
      services:
        - name: minio
          port: 9001
      middlewares:
        - name: skyforge-auth
        - name: strip-minio-console
    - match: PathPrefix(`/netbox/static/`)
      kind: Rule
      priority: 200
      services:
        - name: netbox
          port: 8080
      middlewares:
        - name: replace-netbox-static
    - match: PathPrefix(`/netbox/media/`)
      kind: Rule
      priority: 200
      services:
        - name: netbox
          port: 8080
      middlewares:
        - name: replace-netbox-media
    - match: PathPrefix(`/netbox`)
      kind: Rule
      priority: 100
      services:
        - name: netbox
          port: 8080
      middlewares:
        - name: skyforge-auth
    - match: PathPrefix(`/nautobot/static/`)
      kind: Rule
      priority: 200
      services:
        - name: nautobot
          port: 8080
      middlewares:
        - name: strip-nautobot
        - name: nautobot-forwarded-proto
    - match: PathPrefix(`/static/`)
      kind: Rule
      priority: 200
      services:
        - name: nautobot
          port: 8080
      middlewares:
        - name: nautobot-forwarded-proto
    - match: PathPrefix(`/nautobot/media/`)
      kind: Rule
      priority: 200
      services:
        - name: nautobot
          port: 8080
      middlewares:
        - name: strip-nautobot
        - name: nautobot-forwarded-proto
    - match: PathPrefix(`/media/`)
      kind: Rule
      priority: 200
      services:
        - name: nautobot
          port: 8080
      middlewares:
        - name: nautobot-forwarded-proto
    - match: PathPrefix(`/nautobot`)
      kind: Rule
      priority: 100
      services:
        - name: nautobot
          port: 8080
      middlewares:
        - name: skyforge-auth
        - name: strip-nautobot
        - name: nautobot-forwarded-proto
    - match: PathPrefix(`/labs`)
      kind: Rule
      priority: 100
      services:
        - name: skyforge-server
          port: 8085
      middlewares:
        - name: skyforge-auth
    - match: PathPrefix(`/labs`)
      kind: Rule
      priority: 250
      services:
        - name: skyforge-server
          port: 8085
      middlewares:
        - name: skyforge-auth
    - match: PathPrefix(`/git`)
      kind: Rule
      services:
        - name: gitea
          port: 3000
      middlewares:
        - name: strip-git
        - name: skyforge-auth
    - match: Path(`/swagger/openapi.json`)
      kind: Rule
      priority: 200
      services:
        - name: skyforge-server
          port: 8085
    - match: PathPrefix(`/swagger`)
      kind: Rule
      services:
        - name: swagger-ui
          port: 8080
      middlewares:
        - name: strip-swagger
    - match: PathPrefix(`/workspaces`)
      kind: Rule
      services:
        - name: coder
          port: 7080
      middlewares:
        - name: skyforge-auth
        - name: coder-basepath
    - match: PathPrefix(`/api-testing`)
      kind: Rule
      priority: 600
      services:
        - name: yaade
          port: 80
      middlewares:
        - name: skyforge-auth
    - match: PathPrefix(`/coder`)
      kind: Rule
      priority: 205
      services:
        - name: skyforge-portal
          port: 3000
      middlewares:
        - name: coder-portal-redirect
    - match: PathPrefix(`/templates`) || PathPrefix(`/tasks`)
      kind: Rule
      priority: 210
      services:
        - name: coder
          port: 7080
      middlewares:
        - name: skyforge-auth
    - match: Path(`/oauth_callback`)
      kind: Rule
      services:
        - name: minio
          port: 9001
    - match: PathPrefix(`/api/v2`)
      kind: Rule
      priority: 220
      services:
        - name: coder
          port: 7080
    - match: PathPrefix(`/dex`)
      kind: Rule
      services:
        - name: dex
          port: 5556
    - match: PathPrefix(`/dex-coder`)
      kind: Rule
      priority: 221
      services:
        - name: dex-coder
          port: 5556
      middlewares:
        - name: skyforge-auth
    - match: PathPrefix(`/webhooks`)
      kind: Rule
      services:
        - name: skyforge-portal
          port: 3000
      middlewares:
        - name: skyforge-auth

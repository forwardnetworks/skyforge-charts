apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/app-root: "/index.html"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: skyforge-server
                port:
                  number: 8085
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-root
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/index.html"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /
            pathType: Exact
            backend:
              service:
                name: skyforge-server
                port:
                  number: 8085
---
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-git
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/$2"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /git(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: gitea
                port:
                  number: 3000
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-files
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/skyforge-files/$2"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /files(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: minio
                port:
                  number: 9000
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-minio-console
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/$2"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /minio-console(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: minio
                port:
                  number: 9001
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-api-testing
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /api-testing
            pathType: Prefix
            backend:
              service:
                name: yaade
                port:
                  number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-netbox
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /netbox
            pathType: Prefix
            backend:
              service:
                name: netbox
                port:
                  number: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-netbox-static
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/static/$2"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /netbox/static(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: netbox
                port:
                  number: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-netbox-media
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/media/$2"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /netbox/media(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: netbox
                port:
                  number: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-nautobot
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/$2"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /nautobot(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: nautobot
                port:
                  number: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-coder
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-url: "http://skyforge-server.skyforge.svc.cluster.local:8085/api/session/nginx"
    nginx.ingress.kubernetes.io/auth-signin: "/api/oidc/login?next=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Skyforge-Username,X-Skyforge-DisplayName,X-Skyforge-Email,X-Skyforge-Groups,X-Skyforge-First-Name,X-Skyforge-Last-Name,X-Forwarded-User,X-Forwarded-Email,X-Forwarded-First-Name,X-Forwarded-Last-Name,Remote-User,Remote-User-Email,Remote-User-First-Name,Remote-User-Last-Name"
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header Cookie $http_cookie;
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /workspaces
            pathType: Prefix
            backend:
              service:
                name: coder
                port:
                  number: 7080
          - path: /templates
            pathType: Prefix
            backend:
              service:
                name: coder
                port:
                  number: 7080
          - path: /tasks
            pathType: Prefix
            backend:
              service:
                name: coder
                port:
                  number: 7080
          - path: /api/v2
            pathType: Prefix
            backend:
              service:
                name: coder
                port:
                  number: 7080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-coder-redirect
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/permanent-redirect: "https://__SKYFORGE_HOSTNAME____SKYFORGE_CODER_PORTAL_REDIRECT_PATH__"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /coder
            pathType: Prefix
            backend:
              service:
                name: coder
                port:
                  number: 7080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skyforge-dex
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - __SKYFORGE_HOSTNAME__
      secretName: proxy-tls
  rules:
    - host: __SKYFORGE_HOSTNAME__
      http:
        paths:
          - path: /dex
            pathType: Prefix
            backend:
              service:
                name: dex
                port:
                  number: 5556
          - path: /dex-coder
            pathType: Prefix
            backend:
              service:
                name: dex-coder
                port:
                  number: 5556

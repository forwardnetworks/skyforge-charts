{{- define "skyforge.forwardAppProxyEnvoyConfig" -}}
{{- $cfg := (get .Values.skyforge "forwardApp" | default dict) -}}
{{- $ns := .Release.Namespace -}}
{{- $pathPrefix := (get $cfg "pathPrefix" | default "/fwd") -}}
{{- $upNs := (get $cfg "upstreamNamespace" | default "forward") -}}
{{- $upSvc := (get $cfg "upstreamService" | default "fwd-appserver") -}}
{{- $upPort := (get $cfg "upstreamPort" | default 8080) -}}
{{- $upstreamTLS := (get $cfg "upstreamTLS" | default false) -}}
{{- $publicHost := (.Values.skyforge.hostname | default "skyforge.local.forwardnetworks.com") -}}
{{- $requireAuth := (ternary (get $cfg "requireAuth") true (hasKey $cfg "requireAuth")) -}}
{{- $sessionCookie := (.Values.skyforge.sessionCookie | default "skyforge_session") -}}
{{- $autosleep := (get $cfg "autosleep" | default dict) -}}
{{- $autosleepEnabled := (get $autosleep "enabled" | default false) -}}
{{- $rootAliases := (get $cfg "rootAliases" | default dict) -}}
{{- $rootAliasesEnabled := (get $rootAliases "enabled" | default false) -}}
{{- $rootAliasPaths := (get $rootAliases "paths" | default (list "/login" "/logout")) -}}
admin:
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:
  listeners:
    - name: listener_http
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8080
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                normalize_path: true
                use_remote_address: true
                stream_idle_timeout: 300s
                upgrade_configs:
                  - upgrade_type: websocket
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: forward_app
                      domains: ["*"]
                      routes:
{{- if $rootAliasesEnabled }}
{{- range $p := $rootAliasPaths }}
                        - match:
                            path: {{ $p | quote }}
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy{{ $p }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: {{ $p | quote }}
{{- end }}
{{- end }}
{{- end }}
                        - match:
                            path: "/login"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/login
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /login
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/logout"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/logout
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /logout
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/public/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/public/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /public/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/saml2/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/saml2/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /saml2/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/login/saml2/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/login/saml2/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /login/saml2/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/session"
                          route:
                            cluster: skyforge_server
                            prefix_rewrite: /api/session
                        - match:
                            path: "/api/ui/config"
                          route:
                            cluster: skyforge_server
                            prefix_rewrite: /api/ui/config
                        - match:
                            prefix: "/api/"
                            headers:
                              - name: referer
                                string_match:
                                  safe_regex:
                                    google_re2: {}
                                    regex: ".*/fwd.*"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/"
                            headers:
                              - name: cookie
                                string_match:
                                  safe_regex:
                                    google_re2: {}
                                    regex: ".*(SESSION|JSESSIONID)=.*"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/public/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/public/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/public/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/users/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/users/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/users/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/backups"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/backups
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/backups
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/critical-states"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/critical-states
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/critical-states
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/licenses"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/licenses
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/licenses
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/collector-tasks"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/collector-tasks
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/collector-tasks
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/notifications"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/notifications
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/notifications
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/networks"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/networks
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/networks
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/custom-banners"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/custom-banners
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/custom-banners
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/licensed-devices"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/licensed-devices
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/licensed-devices
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/backup-settings"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/backup-settings
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/backup-settings
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/api/webhooks"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/webhooks
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/webhooks
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/system/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/system/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/system/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/integrations/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api/integrations/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api/integrations/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api/"
                          route:
                            cluster: skyforge_server
                            prefix_rewrite: /api/
                        - match:
                            prefix: "/release-notes/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/release-notes/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /release-notes/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/docs"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/docs
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /docs
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/api-doc"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/api-doc
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /api-doc
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/swagger"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/swagger
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /swagger
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/v3/api-docs"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/v3/api-docs
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /v3/api-docs
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/img/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/img/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /img/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: "/favicon.ico"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/favicon.ico
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /favicon.ico
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/app/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/app/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /app/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: "/fonts/"
                          route:
{{- if $autosleepEnabled }}
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/fonts/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /fonts/
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        # Route exact /fwd directly. Avoid an extra redirect hop that can
                        # lose scheme/context through intermediate proxies.
                        - match:
                            path: {{ $pathPrefix | quote }}
                          route:
{{- if $autosleepEnabled }}
                            # When autosleep is enabled, route to Skyforge server which
                            # wakes Forward workloads and then reverse-proxies to the
                            # in-cluster Forward appserver.
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            # Strip /fwd from incoming requests to the upstream.
                            prefix_rewrite: /
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            path: {{ printf "%s/" $pathPrefix | quote }}
                          route:
{{- if $autosleepEnabled }}
                            # Treat /fwd/ the same as /fwd so browser/bookmark entries hit
                            # the wake/proxy path instead of bypassing to upstream directly.
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            prefix_rewrite: /
                            host_rewrite_header: x-forwarded-host
{{- end }}
                        - match:
                            prefix: {{ printf "%s/" $pathPrefix | quote }}
                          route:
{{- if $autosleepEnabled }}
                            # Route all /fwd/* through Skyforge's on-prem proxy so
                            # headers/cookies/redirect rewriting are consistent.
                            cluster: skyforge_server
                            prefix_rewrite: /api/forward/onprem/proxy/
                            host_rewrite_literal: {{ $publicHost | quote }}
{{- else }}
                            cluster: forward_upstream
                            # Strip /fwd from incoming requests to the upstream.
                            prefix_rewrite: /
                            host_rewrite_header: x-forwarded-host
{{- end }}
                http_filters:
                  # If the browser isn't already logged into Skyforge, Envoy's ext_authz
                  # filter will deny with a 403 (it can't forward a 302).
                  #
                  # Make /fwd behave like other SSO proxies by redirecting to Skyforge
                  # login when the session cookie is missing.
                  #
                  # This runs before ext_authz and also performs best-effort Location
                  # rewriting on responses from the Forward upstream.
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        local function url_encode(str)
                          if str == nil then
                            return ""
                          end
                          -- Encode everything except a conservative set plus '/' so paths stay readable.
                          return (string.gsub(str, "([^%w%-%_%.%~/%/])", function(c)
                            return string.format("%%%02X", string.byte(c))
                          end))
                        end

                        function envoy_on_request(handle)
                          local require_auth = {{ ternary "true" "false" $requireAuth }}
                          if not require_auth then
                            return
                          end

                          local path = handle:headers():get(":path")
                          if path == nil or path == "" then
                            path = "/"
                          end

                          local cookie = handle:headers():get("cookie")
                          local has_skyforge_session = cookie ~= nil and string.find(cookie, "{{ $sessionCookie }}=", 1, true) ~= nil
                          if has_skyforge_session then
                            return
                          end

                          local referer = handle:headers():get("referer")
                          local from_fwd_referer = referer ~= nil and string.find(referer, "{{ $pathPrefix }}", 1, true) ~= nil
                          local has_forward_session = cookie ~= nil and (
                            string.find(cookie, "SESSION=", 1, true) ~= nil or
                            string.find(cookie, "JSESSIONID=", 1, true) ~= nil
                          )

                          local is_forward_path =
                            path == "{{ $pathPrefix }}" or
                            string.sub(path, 1, {{ add (len $pathPrefix) 1 }}) == "{{ $pathPrefix }}/" or
                            path == "/login" or
                            path == "/logout" or
                            string.sub(path, 1, 5) == "/app/" or
                            string.sub(path, 1, 7) == "/fonts/" or
                            string.sub(path, 1, 8) == "/public/" or
                            string.sub(path, 1, 7) == "/saml2/" or
                            string.sub(path, 1, 13) == "/login/saml2/" or
                            string.sub(path, 1, 5) == "/img/" or
                            string.sub(path, 1, 15) == "/release-notes/" or
                            string.sub(path, 1, 6) == "/docs/" or
                            string.sub(path, 1, 9) == "/api-doc/" or
                            string.sub(path, 1, 9) == "/swagger/" or
                            string.sub(path, 1, 13) == "/v3/api-docs/" or
                            path == "/favicon.ico"

                          if string.sub(path, 1, 5) == "/api/" then
                            is_forward_path = is_forward_path or from_fwd_referer or has_forward_session
                          end

                          if not is_forward_path then
                            return
                          end

                          local uri = handle:headers():get("x-forwarded-uri")
                          if uri == nil or uri == "" then
                            uri = handle:headers():get(":path")
                          end
                          if uri == nil or uri == "" then
                            uri = "/"
                          end

                          handle:respond(
                            {
                              [":status"] = "302",
                              ["location"] = "/api/oidc/login?next=" .. url_encode(uri),
                              ["cache-control"] = "no-store",
                            },
                            "redirecting to login\\n"
                          )
                        end

                        function envoy_on_response(handle)
                          local content_type = handle:headers():get("content-type")
                          if content_type ~= nil and string.find(string.lower(content_type), "application/json", 1, true) ~= nil then
                            local body = handle:body()
                            if body ~= nil then
                              local len = body:length()
                              if len ~= nil and len > 0 then
                                local raw = body:getBytes(0, len)
                                local rewritten = string.gsub(raw, [["location"%s*:%s*"/"]], [["location":"{{ $pathPrefix }}/"]])
                                if rewritten ~= raw then
                                  body:setBytes(rewritten)
                                end
                              end
                            end
                          end

                          local orig_loc = handle:headers():get("location")
                          local loc = orig_loc
                          if loc == nil then
                            return
                          end

                          -- Rewrite absolute same-host redirects as well as relative
                          -- redirects so browser navigation remains scoped under /fwd.
                          if string.sub(loc, 1, 1) ~= "/" then
                            local authority = handle:headers():get("x-forwarded-host")
                            if authority == nil or authority == "" then
                              authority = handle:headers():get(":authority")
                            end
                            if authority == nil or authority == "" then
                              authority = handle:headers():get("host")
                            end
                            if authority ~= nil and authority ~= "" then
                              local http_prefix = "http://" .. authority
                              local https_prefix = "https://" .. authority
                              if string.sub(loc, 1, string.len(http_prefix)) == http_prefix then
                                loc = string.sub(loc, string.len(http_prefix) + 1)
                              elseif string.sub(loc, 1, string.len(https_prefix)) == https_prefix then
                                loc = string.sub(loc, string.len(https_prefix) + 1)
                              else
                                return
                              end
                            else
                              -- Fallback: normalize absolute URLs even without forwarded host hints.
                              local stripped = string.match(loc, "^https?://[^/]+(.*)$")
                              if stripped == nil then
                                return
                              end
                              loc = stripped
                            end

                            if loc == "" then
                              loc = "/"
                            elseif string.sub(loc, 1, 1) ~= "/" then
                              loc = "/" .. loc
                            end
                          end

                          local login_prefix = "/api/oidc/login"
                          if string.sub(loc, 1, string.len(login_prefix)) == login_prefix then
                            return
                          end

                          local is_forward_loc =
                            loc == "/" or
                            loc == "/login" or
                            loc == "/logout" or
                            string.sub(loc, 1, 5) == "/app/" or
                            string.sub(loc, 1, 7) == "/fonts/" or
                            string.sub(loc, 1, 8) == "/public/" or
                            string.sub(loc, 1, 7) == "/saml2/" or
                            string.sub(loc, 1, 13) == "/login/saml2/" or
                            string.sub(loc, 1, 5) == "/img/" or
                            string.sub(loc, 1, 15) == "/release-notes/" or
                            string.sub(loc, 1, 6) == "/docs/" or
                            string.sub(loc, 1, 9) == "/api-doc/" or
                            string.sub(loc, 1, 9) == "/swagger/" or
                            string.sub(loc, 1, 13) == "/v3/api-docs/" or
                            string.sub(loc, 1, 5) == "/api/" or
                            loc == "/favicon.ico"
                          if not is_forward_loc then
                            return
                          end
                          if string.sub(loc, 1, {{ add (len $pathPrefix) 1 }}) == "{{ $pathPrefix }}/" or loc == "{{ $pathPrefix }}" then
                            return
                          end
{{- if $rootAliasesEnabled }}
                          if loc == "/" then
                            handle:headers():replace("location", "{{ $pathPrefix }}/")
                            return
                          end
{{- end }}
                          handle:headers():replace("location", "{{ $pathPrefix }}" .. loc)
                        end
{{- if $requireAuth }}
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      transport_api_version: V3
                      failure_mode_allow: false
                      http_service:
                        server_uri:
                          uri: http://skyforge-server.{{ $ns }}.svc.cluster.local:8085
                          cluster: skyforge_server
                          timeout: 2s
                        path_prefix: /api/session/forwardauth/envoy
                        authorization_request:
                          allowed_headers:
                            patterns:
                              - exact: cookie
                              - exact: x-forwarded-proto
                              - exact: x-forwarded-host
                              - exact: x-forwarded-for
                              - exact: x-forwarded-uri
                              - exact: x-forwarded-prefix
                              - exact: user-agent
                              - exact: accept
                              - exact: accept-language
                              - exact: x-skyforge-external-prefix
                        authorization_response:
                          allowed_upstream_headers:
                            patterns:
                              - exact: remote-user
                              - exact: remote-user-group
                              - exact: remote-user-email
                              - exact: remote-user-first-name
                              - exact: remote-user-last-name
                              - exact: x-forwarded-user
                              - exact: x-forwarded-email
                              - exact: x-forwarded-first-name
                              - exact: x-forwarded-last-name
                          allowed_client_headers:
                            patterns:
                              - exact: location
{{- end }}
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    - name: skyforge_server
      type: STRICT_DNS
      connect_timeout: 2s
      load_assignment:
        cluster_name: skyforge_server
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: skyforge-server.{{ $ns }}.svc.cluster.local
                      port_value: 8085

    - name: forward_upstream
      type: STRICT_DNS
      connect_timeout: 5s
{{- if $upstreamTLS }}
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: {{ printf "%s.%s.svc.cluster.local" $upSvc $upNs | quote }}
{{- end }}
      load_assignment:
        cluster_name: forward_upstream
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: {{ $upSvc }}.{{ $upNs }}.svc.cluster.local
                      port_value: {{ $upPort }}
{{- end -}}

{{- $cfg := (get .Values.skyforge "forwardApp" | default dict) -}}
{{- if (get $cfg "enabled" | default false) -}}
{{- $envoyImage := default "envoyproxy/envoy:v1.31.2" .Values.images.envoy -}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: forward-app-proxy-envoy
  labels:
    {{- include "skyforge.labels" . | nindent 4 }}
data:
  envoy.yaml: |
{{ include "skyforge.forwardAppProxyEnvoyConfig" . | nindent 4 }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: forward-app-proxy
  labels:
    {{- include "skyforge.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: forward-app-proxy
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: forward-app-proxy
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: sso-proxy
      annotations:
        checksum/forward-app-proxy-envoy: {{ include "skyforge.forwardAppProxyEnvoyConfig" . | sha256sum }}
    spec:
      automountServiceAccountToken: false
      containers:
        - name: envoy
          image: {{ $envoyImage | quote }}
          imagePullPolicy: IfNotPresent
          args:
            - "-c"
            - "/etc/envoy/envoy.yaml"
          ports:
            - name: http
              containerPort: 8080
            - name: admin
              containerPort: 9901
          readinessProbe:
            httpGet:
              path: /ready
              port: 9901
            initialDelaySeconds: 2
            periodSeconds: 5
            timeoutSeconds: 2
          livenessProbe:
            httpGet:
              path: /ready
              port: 9901
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 2
          volumeMounts:
            - name: envoy-conf
              mountPath: /etc/envoy/envoy.yaml
              subPath: envoy.yaml
      volumes:
        - name: envoy-conf
          configMap:
            name: forward-app-proxy-envoy

---
apiVersion: v1
kind: Service
metadata:
  name: forward-app-proxy
  labels:
    {{- include "skyforge.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: forward-app-proxy
    app.kubernetes.io/instance: {{ .Release.Name }}
  ports:
    - name: http
      port: 8080
      targetPort: 8080
{{- end }}

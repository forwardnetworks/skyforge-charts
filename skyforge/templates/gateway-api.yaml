{{- $host := .Values.skyforge.hostname -}}
{{- $giteaEnabled := .Values.skyforge.gitea.enabled -}}
{{- $minioEnabled := .Values.skyforge.minio.enabled -}}
{{- $yaadeEnabled := .Values.skyforge.yaade.enabled -}}
{{- $swaggerEnabled := .Values.skyforge.swaggerUI.enabled -}}
{{- $dexEnabled := .Values.skyforge.dex.enabled -}}
{{- $coderEnabled := .Values.skyforge.coder.enabled -}}
{{- $forwardApp := (get .Values.skyforge "forwardApp" | default dict) -}}

apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: skyforge
  labels:
    {{- include "skyforge.labels" . | nindent 4 }}
spec:
  gatewayClassName: cilium
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: proxy-tls
      allowedRoutes:
        namespaces:
          from: Same
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: skyforge
  labels:
    {{- include "skyforge.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: skyforge
  hostnames:
    - {{ $host | quote }}
  rules:
    # Core Skyforge endpoints
    - matches:
        - path:
            type: PathPrefix
            value: /assets/skyforge/
      backendRefs:
        - name: skyforge-server
          port: 8085
    - matches:
        - path:
            type: PathPrefix
            value: /healthz
        - path:
            type: PathPrefix
            value: /health
      backendRefs:
        - name: skyforge-server
          port: 8085

{{- if $dexEnabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /dex
      backendRefs:
        - name: dex
          port: 5556
{{- end }}
{{- if $coderEnabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /dex-coder
      backendRefs:
        - name: dex-coder
          port: 5556
{{- end }}

    # Root landing: / -> /index.html
    - matches:
        - path:
            type: Exact
            value: /
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplaceFullPath
              replaceFullPath: /index.html
      backendRefs:
        - name: skyforge-server
          port: 8085

    # Default catch-all to Skyforge server
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: skyforge-server
          port: 8085
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: skyforge-tools
  labels:
    {{- include "skyforge.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: skyforge
  hostnames:
    - {{ $host | quote }}
  rules:
    # Always serve the OpenAPI schema from Skyforge, even when the API docs UI is enabled.
    # (We route this Exact match before any PathPrefix rewrite rules.)
    - matches:
        - path:
            type: Exact
            value: /openapi.json
        - path:
            type: Exact
            value: /swagger/openapi.json
      backendRefs:
        - name: skyforge-server
          port: 8085
{{- if (get $forwardApp "enabled" | default false) }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ (get $forwardApp "pathPrefix" | default "/fwd") | quote }}
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
              - name: X-Forwarded-Prefix
                value: {{ (get $forwardApp "pathPrefix" | default "/fwd") | quote }}
              - name: X-Skyforge-External-Prefix
                value: {{ (get $forwardApp "pathPrefix" | default "/fwd") | quote }}
      backendRefs:
        - name: forward-app-proxy
          port: 8080
{{- end }}
{{- if $minioEnabled }}
    # /files/* -> minio:9000 /skyforge-files/*
    - matches:
        - path:
            type: PathPrefix
            value: /files/
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /skyforge-files/
      backendRefs:
        - name: minio
          port: 9000

    # /minio-console/* -> minio:9001 /*
    - matches:
        - path:
            type: PathPrefix
            value: /minio-console
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: minio
          port: 9001
{{- end }}

{{- if $yaadeEnabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /api-testing
      backendRefs:
        - name: yaade
          port: 80
{{- end }}

{{- if .Values.skyforge.netbox.enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /netbox/static/
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /static/
      backendRefs:
        - name: netbox
          port: 8080
    - matches:
        - path:
            type: PathPrefix
            value: /netbox/media/
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /media/
      backendRefs:
        - name: netbox
          port: 8080
    - matches:
        - path:
            type: PathPrefix
            value: /netbox
      backendRefs:
        - name: netbox-sso-proxy
          port: 8080
{{- end }}

{{- if .Values.skyforge.nautobot.enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /nautobot
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
              - name: X-Skyforge-External-Prefix
                value: /nautobot
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: nautobot-sso-proxy
          port: 8080
{{- end }}

{{- if $giteaEnabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /git
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Skyforge-External-Prefix
                value: /git
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: gitea-sso-proxy
          port: 8080
{{- end }}


{{- if $coderEnabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /coder
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: coder
          port: 7080
    - matches:
        - path:
            type: PathPrefix
            value: /api/v2
      backendRefs:
        - name: coder
          port: 7080
{{- end }}

{{- if .Values.skyforge.dns.enabled }}
    - matches:
        - path:
            type: PathPrefix
            value: /dns
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: technitium-dns
          port: 5380
{{- end }}

{{- $elastic := (get .Values.skyforge "elastic" | default (dict)) -}}
{{- if (get $elastic "enabled" | default false) }}
    - matches:
        - path:
            type: PathPrefix
            value: {{ default "/kibana" (get $elastic "kibanaSubpath") | quote }}
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
              - name: X-Skyforge-External-Prefix
                value: {{ default "/kibana" (get $elastic "kibanaSubpath") | quote }}
      backendRefs:
        - name: kibana-sso-proxy
          port: 8080
{{- end }}

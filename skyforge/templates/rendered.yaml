{{- $skip := dict
  "backup-postgres-minio-cronjob.yaml" true
  "backup-postgres-s3-cronjob.yaml" true
  "replicate-minio-aws-s3-cronjob.yaml" true
  "gitea-admin-sync-deployment.yaml" true
  "netbox-admin-sync-deployment.yaml" true
  "nautobot-admin-sync-deployment.yaml" true
-}}
{{- $vals := fromYaml (toYaml .Values) -}}
{{- $dnsEnabled := dig "skyforge" "dns" "enabled" false $vals -}}
{{- $dnsNodePort := dig "skyforge" "dns" "nodePort" 30053 $vals -}}
{{- $dnsWebNodePort := dig "skyforge" "dns" "webNodePort" 30380 $vals -}}
{{- $technitiumDnsImage := dig "images" "technitiumDns" "technitium/dns-server:latest" $vals -}}
{{- $healthHttpChecks := .Values.skyforge.health.httpChecks -}}
{{- if $dnsEnabled -}}
  {{- if not (contains "|dns|" $healthHttpChecks) -}}
    {{- if ne (trim $healthHttpChecks) "" -}}
      {{- $healthHttpChecks = printf "%s;DNS|dns|http://technitium-dns:5380/|/dns/" (trim $healthHttpChecks) -}}
    {{- else -}}
      {{- $healthHttpChecks = "DNS|dns|http://technitium-dns:5380/|/dns/" -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $images := dict
  "alpine:3.20" .Values.images.alpine
  "arigaio/atlas:latest-alpine" .Values.images.atlas
  "freeradius/freeradius-server:3.2.5" .Values.images.freeradius
  "gitea/gitea:1.22.3-rootless" .Values.images.gitea
  "ghcr.io/coder/coder:latest" .Values.images.coder
  "ghcr.io/dexidp/dex:v2.37.0" .Values.images.dex
  "esperotech/yaade:latest" .Values.images.yaade
  "minio/minio:RELEASE.2024-11-07T00-52-20Z" .Values.images.minio
  "minio/mc:latest" .Values.images.minioMc
  "minio/mc:RELEASE.2024-11-17T19-35-25Z" .Values.images.minioMcRelease
  "postgres:15-alpine" .Values.images.postgres
  "redis:7-alpine" .Values.images.redis
  "technitium/dns-server:latest" $technitiumDnsImage
  "swaggerapi/swagger-ui:v5.11.0" .Values.images.swaggerUi
  "skyforge-nautobot:latest" .Values.images.skyforgeNautobot
  "skyforge-netbox:latest" .Values.images.skyforgeNetbox
  "skyforge-server:latest" .Values.images.skyforgeServer
-}}
{{- $hostname := .Values.skyforge.hostname | required "skyforge.hostname is required" -}}
{{- $domain := .Values.skyforge.domain | required "skyforge.domain is required" -}}
{{- $giteaUrl := .Values.skyforge.gitea.url -}}
{{- if eq $giteaUrl "" }}{{- $giteaUrl = printf "https://%s/git" $hostname -}}{{- end -}}
{{- $giteaApiUrl := .Values.skyforge.gitea.apiUrl -}}
{{- if eq $giteaApiUrl "" }}{{- $giteaApiUrl = "http://gitea:3000/api/v1" -}}{{- end -}}
{{- $netboxUrl := .Values.skyforge.netboxUrl -}}
{{- if eq $netboxUrl "" }}{{- $netboxUrl = printf "https://%s/netbox" $hostname -}}{{- end -}}
{{- $netboxSsoUrl := .Values.skyforge.netboxSsoUrl -}}
{{- $nautobotUrl := .Values.skyforge.nautobotUrl -}}
{{- if eq $nautobotUrl "" }}{{- $nautobotUrl = printf "https://%s/nautobot" $hostname -}}{{- end -}}
{{- $nautobotSsoUrl := .Values.skyforge.nautobotSsoUrl -}}
{{- $swaggerUrl := .Values.skyforge.swaggerUrl -}}
{{- if eq $swaggerUrl "" }}{{- $swaggerUrl = printf "https://%s/swagger/openapi.json" $hostname -}}{{- end -}}
{{- $cookieDomain := dig "skyforge" "cookieDomain" "" $vals -}}
{{- $giteaAllowedDomains := .Values.skyforge.gitea.allowedDomains -}}
{{- if eq $giteaAllowedDomains "" }}{{- $giteaAllowedDomains = printf "gitea,localhost,127.0.0.1,%s" $hostname -}}{{- end -}}
{{- $valuesChecksum := sha256sum (toJson .Values) -}}
{{- $infraAPIChecksum := sha256sum (.Files.Get "files/infra.api.config.json") -}}
{{- $replacements := dict
  "__SKYFORGE_HOSTNAME__" $hostname
  "__SKYFORGE_DOMAIN__" $domain
  "__SKYFORGE_LDAP_BASEDN__" .Values.skyforge.ldap.baseDn
  "__SKYFORGE_ADMIN_USERS__" .Values.skyforge.adminUsers
  "__SKYFORGE_AWS_SSO_REGION__" .Values.skyforge.awsSsoRegion
  "__SKYFORGE_AWS_SSO_START_URL__" .Values.skyforge.awsSsoStartUrl
  "__SKYFORGE_GITEA_API_URL__" $giteaApiUrl
  "__SKYFORGE_GITEA_URL__" $giteaUrl
  "__SKYFORGE_GITEA_USERNAME__" .Values.skyforge.gitea.username
  "__SKYFORGE_SSO_SKIP_TLS_VERIFY__" (printf "%v" .Values.skyforge.ssoSkipTlsVerify)
  "__SKYFORGE_GITEA_REPO_PRIVATE__" (printf "%v" .Values.skyforge.gitea.repoPrivate)
  "__SKYFORGE_NETBOX_SSO_URL__" $netboxSsoUrl
  "__SKYFORGE_NAUTOBOT_SSO_URL__" $nautobotSsoUrl
  "__SKYFORGE_LDAP_DISPLAY_ATTR__" .Values.skyforge.ldap.displayAttr
  "__SKYFORGE_LDAP_GROUP_ATTR__" .Values.skyforge.ldap.groupAttr
  "__SKYFORGE_LDAP_MAIL_ATTR__" .Values.skyforge.ldap.mailAttr
  "__SKYFORGE_LDAP_SKIP_TLS_VERIFY__" (printf "%v" .Values.skyforge.ldap.skipTlsVerify)
  "__SKYFORGE_LDAP_STARTTLS__" (printf "%v" .Values.skyforge.ldap.startTls)
  "__SKYFORGE_LISTEN_ADDR__" .Values.skyforge.listenAddr
  "__SKYFORGE_MAX_GROUPS__" (printf "%v" .Values.skyforge.maxGroups)
  "__SKYFORGE_NETBOX_URL__" $netboxUrl
  "__SKYFORGE_NETBOX_MGMT_SUBNET__" .Values.skyforge.netboxMgmtSubnet
  "__SKYFORGE_NAUTOBOT_URL__" $nautobotUrl
  "__SKYFORGE_YAADE_URL__" .Values.skyforge.yaadeUrl
  "__SKYFORGE_YAADE_ADMIN_USERNAME__" .Values.skyforge.yaadeAdminUsername
  "__SKYFORGE_OBJECT_STORAGE_ENDPOINT__" .Values.skyforge.objectStorage.endpoint
  "__SKYFORGE_OBJECT_STORAGE_USE_SSL__" (printf "%v" .Values.skyforge.objectStorage.useSsl)
  "__SKYFORGE_OBJECT_STORAGE_ACCESS_SECRET_NAME__" .Values.skyforge.objectStorage.accessKeySecretName
  "__SKYFORGE_OBJECT_STORAGE_ACCESS_SECRET_KEY__" .Values.skyforge.objectStorage.accessKeySecretKey
  "__SKYFORGE_OBJECT_STORAGE_SECRET_SECRET_NAME__" .Values.skyforge.objectStorage.secretKeySecretName
  "__SKYFORGE_OBJECT_STORAGE_SECRET_SECRET_KEY__" .Values.skyforge.objectStorage.secretKeySecretKey
	  "__SKYFORGE_NETLAB_SSH_USER__" .Values.skyforge.netlab.sshUser
	  "__SKYFORGE_NETLAB_STATE_ROOT__" .Values.skyforge.netlab.stateRoot
	  "__SKYFORGE_WORKSPACES_DATA_DIR__" .Values.skyforge.workspacesDataDir
	  "__SKYFORGE_WORKSPACE_SYNC_SECONDS__" (printf "%v" .Values.skyforge.workspaceSyncSeconds)
  "__SKYFORGE_PKI_DEFAULT_DAYS__" (printf "%v" .Values.skyforge.pkiDefaultDays)
  "__SKYFORGE_SSH_DEFAULT_DAYS__" (printf "%v" .Values.skyforge.sshDefaultDays)
  "__SKYFORGE_UI_THEME_DEFAULT__" .Values.skyforge.uiThemeDefault
	  "__SKYFORGE_SESSION_TTL__" .Values.skyforge.sessionTtl
	  "__SKYFORGE_COOKIE_SECURE__" (printf "%v" .Values.skyforge.cookieSecure)
	  "__SKYFORGE_COOKIE_DOMAIN__" $cookieDomain
	  "__SKYFORGE_DB_HOST__" .Values.skyforge.db.host
  "__SKYFORGE_DB_PORT__" (printf "%v" .Values.skyforge.db.port)
  "__SKYFORGE_DB_NAME__" .Values.skyforge.db.name
  "__SKYFORGE_DB_USER__" .Values.skyforge.db.user
  "__SKYFORGE_DB_SSLMODE__" .Values.skyforge.db.sslmode
  "__SKYFORGE_HEALTH_HTTP_CHECKS__" $healthHttpChecks
  "__SKYFORGE_HEALTH_CODE_CHECKS__" .Values.skyforge.health.codeChecks
  "__SKYFORGE_MINIO_LDAP_CONSOLE_GROUP__" (dig "skyforge" "minio" "ldapConsoleGroup" "" $vals)
  "__SKYFORGE_OIDC_DISCOVERY_URL__" "http://dex:5556/dex"
  "__SKYFORGE_OIDC_ISSUER_URL__" (printf "https://%s/dex" $hostname)
  "__SKYFORGE_OIDC_REDIRECT_URL__" (printf "https://%s/api/skyforge/api/oidc/callback" $hostname)
  "__SKYFORGE_DNS_NODEPORT__" (printf "%v" $dnsNodePort)
  "__SKYFORGE_DNS_WEB_NODEPORT__" (printf "%v" $dnsWebNodePort)
  "__GITEA_ADMIN_USERNAME__" .Values.skyforge.gitea.adminUsername
  "__GITEA_ALLOWED_DOMAINS__" $giteaAllowedDomains
  "__SKYFORGE_ADMIN_USERNAME__" .Values.skyforge.admin.username
  "__SKYFORGE_ADMIN_NAME__" .Values.skyforge.admin.name
  "__SKYFORGE_PROVISIONER_LOGIN__" .Values.skyforge.provisioner.login
  "__SKYFORGE_PROVISIONER_NAME__" .Values.skyforge.provisioner.name
  "__SKYFORGE_UI_PRODUCT_NAME__" .Values.skyforge.ui.productName
  "__SKYFORGE_UI_PRODUCT_SUBTITLE__" .Values.skyforge.ui.productSubtitle
  "__SKYFORGE_UI_LOGO_URL__" .Values.skyforge.ui.logoUrl
  "__SKYFORGE_UI_LOGO_ALT__" .Values.skyforge.ui.logoAlt
  "__SKYFORGE_UI_HEADER_BG_URL__" .Values.skyforge.ui.headerBgUrl
  "__SKYFORGE_UI_SUPPORT_TEXT__" .Values.skyforge.ui.supportText
  "__SKYFORGE_CODER_PORTAL_REDIRECT_PATH__" .Values.skyforge.coder.portalRedirectPath
  "__SKYFORGE_SERVER_REPLICA_COUNT__" (printf "%v" .Values.skyforge.serverReplicaCount)
  "__SKYFORGE_PORTAL_REPLICA_COUNT__" (printf "%v" .Values.skyforge.portalReplicaCount)
  "__SKYFORGE_WORKER_REPLICA_COUNT__" (printf "%v" .Values.skyforge.workerReplicaCount)
  "__SKYFORGE_SESSION_COOKIE__" .Values.skyforge.sessionCookie
  "__SKYFORGE_SWAGGER_URL__" $swaggerUrl
  "__SKYFORGE_VALUES_CHECKSUM__" $valuesChecksum
  "__SKYFORGE_INFRA_API_CHECKSUM__" $infraAPIChecksum
-}}

{{- range $path, $bytes := .Files.Glob "files/kompose/*.yaml" }}
  {{- $name := base $path -}}
  {{- if not (hasKey $skip $name) }}
    {{- $content := toString $bytes -}}
    {{- range $token, $value := $replacements }}
      {{- $valueStr := printf "%v" $value -}}
      {{- $content = replace $token $valueStr $content -}}
    {{- end }}
    {{- range $old, $new := $images }}
      {{- $content = replace (printf "image: %s" $old) (printf "image: %s" $new) $content -}}
    {{- end }}
    {{- $content = replace "namespace: skyforge" (printf "namespace: %s" $.Release.Namespace) $content -}}
    {{- $content | nindent 0 }}
---
  {{- end }}
{{- end }}

{{- if $dnsEnabled }}
{{- range $path, $bytes := .Files.Glob "files/infra/technitium-dns/*.yaml" }}
  {{- $content := toString $bytes -}}
  {{- range $token, $value := $replacements }}
    {{- $valueStr := printf "%v" $value -}}
    {{- $content = replace $token $valueStr $content -}}
  {{- end }}
  {{- range $old, $new := $images }}
    {{- $content = replace (printf "image: %s" $old) (printf "image: %s" $new) $content -}}
  {{- end }}
  {{- $content = replace "namespace: skyforge" (printf "namespace: %s" $.Release.Namespace) $content -}}
  {{- $content | nindent 0 }}
---
{{- end }}
{{- end }}

{{- range $path, $bytes := .Files.Glob "files/overlays/*.yaml" }}
  {{- $name := base $path -}}
  {{- if not (hasKey $skip $name) }}
    {{- $content := toString $bytes -}}
    {{- range $token, $value := $replacements }}
      {{- $valueStr := printf "%v" $value -}}
      {{- $content = replace $token $valueStr $content -}}
    {{- end }}
    {{- range $old, $new := $images }}
      {{- $content = replace (printf "image: %s" $old) (printf "image: %s" $new) $content -}}
    {{- end }}
    {{- $content = replace "namespace: skyforge" (printf "namespace: %s" $.Release.Namespace) $content -}}
    {{- $content | nindent 0 }}
---
  {{- end }}
{{- end }}

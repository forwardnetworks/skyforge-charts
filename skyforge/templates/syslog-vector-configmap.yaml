{{- /*
Vector syslog collector configuration.

- Runs as a DaemonSet with hostNetwork, listening on UDP/514 (or configured port).
- Forwards events to skyforge-server's internal ingest endpoint using SKYFORGE_INTERNAL_TOKEN.
*/ -}}
{{- if and .Values.skyforge .Values.skyforge.syslog .Values.skyforge.syslog.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: skyforge-syslog-vector
  labels:
{{ include "skyforge.labels" . | indent 4 }}
data:
  vector.yaml: |
    sources:
      syslog_udp:
        # Use the generic UDP socket source and parse syslog in VRL.
        # This is more tolerant across device NOS implementations and avoids strict
        # parsing failures that can drop events.
        type: socket
        mode: udp
        address: "0.0.0.0:{{ default 514 .Values.skyforge.syslog.hostPort }}"
        decoding:
          codec: bytes

    transforms:
      skyforge_syslog:
        type: remap
        inputs:
          - syslog_udp
        source: |
          # Skyforge ingest expects a small normalized JSON shape.
          raw = ""
          if exists(.message) {
            # With `socket` + `bytes` decoding, `.message` is usually bytes.
            raw = string!(.message)
          } else {
            raw = to_string!(.)
          }

          parsed, err = parse_syslog(raw)
          if err != null {
            # Keep the raw line, but still forward it with a best-effort source ip.
            parsed = {}
          }

          # Socket source usually places the sender address in `host`.
          src = ""
          if exists(.host) {
            src = .host
          }
          # Some versions include a nested metadata object.
          if src == "" {
            if exists(.metadata.host) {
              src = .metadata.host
            } else if exists(.metadata.source_ip) {
              src = .metadata.source_ip
            }
          }

          # Ensure src is a string for match/split (socket sources can be loosely typed).
          src = to_string!(src)

          # Strip a trailing :port (common with socket sources).
          if match(src, r'^\d+\.\d+\.\d+\.\d+:\d+$') {
            src = split(src, ":")[0]
          }
          if src == "" {
            src = "0.0.0.0"
          }

          hostname = ""
          if exists(parsed.hostname) { hostname = parsed.hostname }
          app_name = ""
          if exists(parsed.appname) { app_name = parsed.appname }
          proc_id = ""
          if exists(parsed.procid) { proc_id = parsed.procid }
          msg_id = ""
          if exists(parsed.msgid) { msg_id = parsed.msgid }
          msg = ""
          if exists(parsed.message) { msg = parsed.message }

          . = {
            "source_ip": src,
            "hostname": hostname,
            "app_name": app_name,
            "proc_id": proc_id,
            "msg_id": msg_id,
            "message": msg,
            "raw": raw,
            "received_at": format_timestamp!(now(), "%+"),
          }

    sinks:
      skyforge_ingest:
        type: http
        inputs:
          - skyforge_syslog
        uri: "http://skyforge-server:8085/ingest/syslog"
        method: post
        encoding:
          codec: json
        framing:
          method: newline_delimited
        request:
          headers:
            Content-Type: "application/json"
            X-Skyforge-Internal-Token: "${SKYFORGE_INTERNAL_TOKEN}"
        healthcheck:
          enabled: true
        batch:
          max_events: 1
          max_bytes: 1048576
          timeout_secs: 1

{{- if or (and .Values.skyforge .Values.skyforge.elastic .Values.skyforge.elastic.enabled) (and .Values.skyforge .Values.skyforge.syslog .Values.skyforge.syslog.elasticsearch .Values.skyforge.syslog.elasticsearch.enabled) }}
      elasticsearch:
        type: elasticsearch
        inputs:
          - skyforge_syslog
        endpoints:
          - "http://elasticsearch:9200"
        mode: bulk
        bulk:
          index: "skyforge-syslog-%Y.%m.%d"
{{- end }}

{{- end }}

{{- if .Values.skyforge.dex.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: dex-config-patcher
data:
  patch.py: |
    import os
    from pathlib import Path

    import yaml

    src = Path("/etc/dex-src/config.yaml")
    dst = Path("/etc/dex/config.yaml")

    cfg = yaml.safe_load(src.read_text(encoding="utf-8")) or {}
    web = cfg.get("web") or {}
    cfg["web"] = web

    theme = os.environ.get("DEX_WEB_THEME", "").strip()
    logo_url = os.environ.get("DEX_LOGO_URL", "").strip()

    if theme:
        web["theme"] = theme
    if logo_url:
        web["logoURL"] = logo_url

    dst.parent.mkdir(parents=True, exist_ok=True)
    dst.write_text(yaml.safe_dump(cfg, sort_keys=False), encoding="utf-8")
{{- end }}

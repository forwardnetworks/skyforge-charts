{{- if .Values.skyforge.dex.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: dex-config-patcher
data:
  patch.py: |
    import os
    from pathlib import Path
    from urllib.parse import urlparse

    import yaml

    def _truthy(v: str) -> bool:
        return v.strip().lower() in ("1", "true", "t", "yes", "y", "on")

    src = Path("/etc/dex-src/config.yaml")
    dst = Path("/etc/dex/config.yaml")

    cfg = yaml.safe_load(src.read_text(encoding="utf-8")) or {}
    web = cfg.get("web") or {}
    cfg["web"] = web

    theme = os.environ.get("DEX_WEB_THEME", "").strip()
    logo_url = os.environ.get("DEX_LOGO_URL", "").strip()

    if theme:
        web["theme"] = theme
    if logo_url:
        web["logoURL"] = logo_url

    # Optional: add Okta as an extra Dex connector without needing to modify
    # the upstream dex-config Secret (useful when manageConfig=false).
    if _truthy(os.environ.get("DEX_OKTA_ENABLED", "")):
        okta_issuer = os.environ.get("DEX_OKTA_ISSUER", "").strip()
        okta_client_id = os.environ.get("DEX_OKTA_CLIENT_ID", "").strip()
        okta_client_secret = os.environ.get("DEX_OKTA_CLIENT_SECRET", "").strip()
        okta_name = os.environ.get("DEX_OKTA_NAME", "Okta").strip() or "Okta"

        if not okta_issuer:
            raise SystemExit("DEX_OKTA_ISSUER is required when DEX_OKTA_ENABLED=true")
        if not okta_client_id:
            raise SystemExit("DEX_OKTA_CLIENT_ID is required when DEX_OKTA_ENABLED=true")
        if not okta_client_secret:
            raise SystemExit("DEX_OKTA_CLIENT_SECRET is required when DEX_OKTA_ENABLED=true")

        scopes_raw = os.environ.get("DEX_OKTA_SCOPES", "").strip()
        okta_scopes = [s.strip() for s in scopes_raw.split(",") if s.strip()] if scopes_raw else []

        redirect_uri = os.environ.get("DEX_OKTA_REDIRECT_URI", "").strip()
        if not redirect_uri:
            issuer = (cfg.get("issuer") or "").strip()
            u = urlparse(issuer)
            if not u.scheme or not u.netloc:
                raise SystemExit(
                    "DEX_OKTA_REDIRECT_URI is required (unable to infer from Dex issuer)"
                )
            redirect_uri = f"{u.scheme}://{u.netloc}/dex/callback"

        connector = {
            "type": "oidc",
            "id": "okta",
            "name": okta_name,
            "config": {
                "issuer": okta_issuer,
                "clientID": okta_client_id,
                "clientSecret": okta_client_secret,
                "redirectURI": redirect_uri,
            },
        }
        if okta_scopes:
            connector["config"]["scopes"] = okta_scopes

        connectors = cfg.get("connectors") or []
        if not isinstance(connectors, list):
            connectors = []
        connectors = [
            c for c in connectors if not (isinstance(c, dict) and c.get("id") == "okta")
        ]
        connectors.append(connector)
        cfg["connectors"] = connectors

    dst.parent.mkdir(parents=True, exist_ok=True)
    dst.write_text(yaml.safe_dump(cfg, sort_keys=False), encoding="utf-8")
{{- end }}

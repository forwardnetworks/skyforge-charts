{{- if .Values.secrets.create }}
{{- range $name, $secret := .Values.secrets.items }}
{{- /* dex-config is generated by templates/dex-config-secret.yaml when manageConfig=true */ -}}
{{- if or (ne $name "dex-config") (not $.Values.skyforge.dex.manageConfig) }}
{{- $type := default "Opaque" (index $secret "_type") }}
{{- $existing := lookup "v1" "Secret" $.Release.Namespace $name }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $name }}
  {{- if ne $name "skyforge-session-secret" }}
  annotations:
    "helm.sh/resource-policy": keep
  {{- end }}
  labels:
{{ include "skyforge.labels" $ | indent 4 }}
type: {{ $type }}
data:
{{- $data := dict -}}
{{- range $key, $value := $secret }}
  {{- if ne $key "_type" }}
    {{- $raw := default "" (tpl (printf "%v" $value) $) }}
    {{- $clean := trimSuffix "\n" $raw }}
    {{- $existingData := "" -}}
    {{- if $existing -}}
      {{- $existingData = default "" (index $existing.data $key) -}}
    {{- end -}}
    {{- if and (not $existing) (not ($.Capabilities.APIVersions.Has "helm.sh/lint")) (eq $name "skyforge-session-secret") (eq $key "skyforge-session-secret") (eq (trim $clean) "") -}}
      {{- fail "skyforge-session-secret.skyforge-session-secret must be set (populate deploy/skyforge-secrets.yaml)" -}}
    {{- end -}}
    {{- $shouldAutogen := false -}}
    {{- $autogenLen := 32 -}}
    {{- if and (eq (trim $clean) "") (eq $existingData "") -}}
      {{- if or
        (and (eq $name "object-storage-root-user") (eq $key "object-storage-root-user"))
        (and (eq $name "object-storage-root-password") (eq $key "object-storage-root-password"))
        (and (eq $name "object-storage-access-key") (eq $key "object-storage-access-key"))
        (and (eq $name "object-storage-secret-key") (eq $key "object-storage-secret-key"))
        (and (eq $name "object-storage-artifacts-access-key") (eq $key "object-storage-artifacts-access-key"))
        (and (eq $name "object-storage-artifacts-secret-key") (eq $key "object-storage-artifacts-secret-key"))
      -}}
        {{- $shouldAutogen = true -}}
      {{- end -}}
    {{- end -}}
    {{- if $shouldAutogen -}}
      {{- if or (eq $name "object-storage-root-user") (eq $name "object-storage-access-key") (eq $name "object-storage-artifacts-access-key") -}}
        {{- $autogenLen = 20 -}}
      {{- else if or (eq $name "object-storage-secret-key") (eq $name "object-storage-artifacts-secret-key") (eq $name "object-storage-root-password") -}}
        {{- $autogenLen = 40 -}}
      {{- end -}}
    {{- end -}}
    {{- $final := "" -}}
    {{- if $shouldAutogen -}}
      {{- $final = b64enc (randAlphaNum $autogenLen) -}}
    {{- else if and (eq $clean "") (ne $existingData "") -}}
      {{- $final = $existingData -}}
    {{- else -}}
      {{- $final = b64enc $clean -}}
    {{- end -}}
    {{- $_ := set $data $key $final -}}
  {{- end -}}
{{- end }}
{{- toYaml $data | nindent 2 }}
---
{{- end }}
{{- end }}
{{- end }}

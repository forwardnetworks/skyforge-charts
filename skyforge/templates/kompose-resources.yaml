{{- /*
kompose-resources.yaml prints a set of pre-rendered manifests stored under
charts/skyforge/files/kompose/*.yaml.

Important: keep optional stacks (NetBox/Nautobot/etc) gated behind Helm values.
Without gating, QA/OSS install drills cannot disable integrations and will hang
pulling images or waiting on hooks.
*/ -}}

{{- $files := list
  "db-deployment.yaml"
  "db-provision-job.yaml"
  "db-service.yaml"

  "redis-deployment.yaml"
  "redis-service.yaml"
  -}}

{{- if .Values.skyforge.minio.enabled }}
  {{- $files = concat $files (list
    "backup-postgres-minio-cronjob.yaml"

    "minio-deployment.yaml"
    "minio-init-pod.yaml"
    "minio-ldap-init-pod.yaml"
    "minio-skyforge-init-pod.yaml"
    "minio-service.yaml") -}}
{{- end }}

{{- if and .Values.skyforge.minio.enabled .Values.skyforge.gitea.enabled }}
  {{- $files = concat $files (list
    "minio-gitea-init-pod.yaml") -}}
{{- end }}

{{- if .Values.skyforge.gitea.enabled }}
  {{- $files = concat $files (list
    "gitea-admin-bootstrap-job.yaml"
    "gitea-admin-sync-deployment.yaml"
    "gitea-deployment.yaml"
    "gitea-service.yaml") -}}
{{- end }}

{{- if .Values.skyforge.yaade.enabled }}
  {{- $files = concat $files (list
    "yaade-deployment.yaml"
    "yaade-service.yaml") -}}
{{- end }}

{{- if .Values.skyforge.netbox.enabled }}
  {{- $files = concat $files (list
    "netbox-admin-bootstrap-job.yaml"
    "netbox-admin-sync-deployment.yaml"
    "netbox-deployment.yaml"
    "netbox-service.yaml") -}}
{{- end }}

{{- if .Values.skyforge.nautobot.enabled }}
  {{- if (default false .Values.skyforge.nautobot.bootstrap.enabled) }}
    {{- $files = concat $files (list
      "nautobot-admin-bootstrap-job.yaml") -}}
  {{- end }}

  {{- $files = concat $files (list
    "nautobot-admin-sync-deployment.yaml"
    "nautobot-deployment.yaml"
    "nautobot-service.yaml") -}}
{{- end }}

{{- range $files }}
{{- $path := printf "files/kompose/%s" . -}}
{{- if $.Files.Get $path }}
---
{{ if has . (list "netbox-deployment.yaml" "netbox-admin-bootstrap-job.yaml" "nautobot-deployment.yaml") -}}
{{ printf "%s\n" (tpl ($.Files.Get $path) $) -}}
{{ else -}}
{{ printf "%s\n" ($.Files.Get $path) -}}
{{ end -}}
{{ end }}
{{- end }}

{{- if and .Values.skyforge.dex.enabled .Values.skyforge.dex.manageConfig -}}
{{- /*
Generate Dex config from Helm values and existing Secrets.

We intentionally keep Dex's static client secrets in Kubernetes Secrets that are
also consumed by the corresponding applications (Skyforge, Coder). Dex requires
the raw secret in its config, so we hydrate it here from either:
  - the existing Secret (upgrade path), or
  - the Helm values (fresh install path).
*/ -}}

{{- $hostname := required "skyforge.hostname is required" .Values.skyforge.hostname -}}

{{- $dexDbPassword := include "skyforge.secretOrValue" (list . "db-dex-password" "db-dex-password" (index (index .Values.secrets.items "db-dex-password") "db-dex-password" | default "")) -}}
{{- if not $dexDbPassword -}}
  {{- fail "db-dex-password.db-dex-password must be set (Dex uses Postgres storage)" -}}
{{- end -}}

{{- $skyforgeOIDCClientSecret := include "skyforge.secretOrValue" (list . "skyforge-oidc-client-secret" "skyforge-oidc-client-secret" (index (index .Values.secrets.items "skyforge-oidc-client-secret") "skyforge-oidc-client-secret" | default "")) -}}
{{- if not $skyforgeOIDCClientSecret -}}
  {{- fail "skyforge-oidc-client-secret.skyforge-oidc-client-secret must be set (Dex static client 'skyforge')" -}}
{{- end -}}

{{- $coderClientSecret := include "skyforge.secretOrValue" (list . "dex-client-coder-secret" "dex-client-coder-secret" (index (index .Values.secrets.items "dex-client-coder-secret") "dex-client-coder-secret" | default "")) -}}
{{- if and .Values.skyforge.coder.enabled (not $coderClientSecret) -}}
  {{- fail "dex-client-coder-secret.dex-client-coder-secret must be set (Dex static client 'coder')" -}}
{{- end -}}

{{- $giteaClientSecret := include "skyforge.secretOrValue" (list . "dex-client-gitea-secret" "dex-client-gitea-secret" (index (index .Values.secrets.items "dex-client-gitea-secret") "dex-client-gitea-secret" | default "")) -}}
{{- if and .Values.skyforge.gitea.enabled (not $giteaClientSecret) -}}
  {{- fail "dex-client-gitea-secret.dex-client-gitea-secret must be set (Dex static client 'gitea')" -}}
{{- end -}}

{{- $yaadeClientSecret := include "skyforge.secretOrValue" (list . "dex-client-yaade-secret" "dex-client-yaade-secret" (index (index .Values.secrets.items "dex-client-yaade-secret") "dex-client-yaade-secret" | default "")) -}}
{{- if and .Values.skyforge.yaade.enabled (not $yaadeClientSecret) -}}
  {{- fail "dex-client-yaade-secret.dex-client-yaade-secret must be set (Dex static client 'yaade')" -}}
{{- end -}}

{{- $netboxClientSecret := include "skyforge.secretOrValue" (list . "dex-client-netbox-secret" "dex-client-netbox-secret" (index (index .Values.secrets.items "dex-client-netbox-secret") "dex-client-netbox-secret" | default "")) -}}
{{- if and .Values.skyforge.netbox.enabled (not $netboxClientSecret) -}}
  {{- fail "dex-client-netbox-secret.dex-client-netbox-secret must be set (Dex static client 'netbox')" -}}
{{- end -}}

{{- $nautobotClientSecret := include "skyforge.secretOrValue" (list . "dex-client-nautobot-secret" "dex-client-nautobot-secret" (index (index .Values.secrets.items "dex-client-nautobot-secret") "dex-client-nautobot-secret" | default "")) -}}
{{- if and .Values.skyforge.nautobot.enabled (not $nautobotClientSecret) -}}
  {{- fail "dex-client-nautobot-secret.dex-client-nautobot-secret must be set (Dex static client 'nautobot')" -}}
{{- end -}}

{{- $authMode := default "google" .Values.skyforge.dex.authMode -}}

{{- $googleClientID := "" -}}
{{- $googleClientSecret := "" -}}
{{- $googleHostedDomains := default (list) .Values.skyforge.dex.google.hostedDomains -}}
{{- if eq $authMode "google" -}}
  {{- $googleClientID = required "skyforge.dex.google.clientID is required when authMode=google" .Values.skyforge.dex.google.clientID -}}
  {{- $googleClientSecret = include "skyforge.secretOrValue" (list . (default "dex-google-client-secret" .Values.skyforge.dex.google.clientSecretSecretName) (default "dex-google-client-secret" .Values.skyforge.dex.google.clientSecretSecretKey) (index (index .Values.secrets.items "dex-google-client-secret") "dex-google-client-secret" | default "")) -}}
  {{- if not $googleClientSecret -}}
    {{- fail "dex-google-client-secret.dex-google-client-secret must be set (Google connector client secret)" -}}
  {{- end -}}
{{- end -}}

{{- $useOkta := or (eq $authMode "okta") (and .Values.skyforge.dex.okta.enabled (ne $authMode "okta")) -}}
{{- $oktaIssuer := "" -}}
{{- $oktaClientID := "" -}}
{{- $oktaClientSecret := "" -}}
{{- $oktaName := default "Okta" .Values.skyforge.dex.okta.name -}}
{{- $oktaScopes := default (list) .Values.skyforge.dex.okta.scopes -}}
{{- if $useOkta -}}
  {{- $oktaIssuer = required "skyforge.dex.okta.issuer is required when Okta is enabled (authMode=okta or skyforge.dex.okta.enabled=true)" .Values.skyforge.dex.okta.issuer -}}
  {{- $oktaClientID = required "skyforge.dex.okta.clientID is required when Okta is enabled (authMode=okta or skyforge.dex.okta.enabled=true)" .Values.skyforge.dex.okta.clientID -}}
  {{- $oktaClientSecret = include "skyforge.secretOrValue" (list . (default "dex-okta-client-secret" .Values.skyforge.dex.okta.clientSecretSecretName) (default "dex-okta-client-secret" .Values.skyforge.dex.okta.clientSecretSecretKey) (index (index .Values.secrets.items "dex-okta-client-secret") "dex-okta-client-secret" | default "")) -}}
  {{- if not $oktaClientSecret -}}
    {{- fail "dex-okta-client-secret.dex-okta-client-secret must be set (Okta connector client secret)" -}}
  {{- end -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: dex-config
  annotations:
    "helm.sh/resource-policy": keep
  labels:
{{ include "skyforge.labels" . | indent 4 }}
type: Opaque
stringData:
  config.yaml: |
    issuer: https://{{ $hostname }}/dex
    storage:
      type: postgres
      config:
        host: db
        port: 5432
        database: dex
        user: dex
        password: {{ $dexDbPassword | quote }}
        ssl:
          mode: disable
    web:
      http: 0.0.0.0:5556
    oauth2:
      skipApprovalScreen: true
      alwaysShowLoginScreen: false
    connectors:
{{- $hasConnector := or (eq $authMode "google") (or (eq $authMode "ldap") $useOkta) -}}
{{- if eq $authMode "google" }}
      - type: google
        id: google
        name: Google
        config:
          clientID: {{ $googleClientID | quote }}
          clientSecret: {{ $googleClientSecret | quote }}
          redirectURI: {{ printf "https://%s/dex/callback" $hostname | quote }}
{{- if $googleHostedDomains }}
          hostedDomains:
{{- range $googleHostedDomains }}
            - {{ . | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- if eq $authMode "ldap" }}
      - type: ldap
        id: ldap
        name: LDAP
        config:
          # NOTE: LDAP is supported for OSS installs but is disabled by default.
          # Populate these via deploy/skyforge-secrets.yaml (or similar) if needed.
          host: {{ default "" .Values.skyforge.dex.ldap.host | quote }}
          startTLS: {{ default false .Values.skyforge.dex.ldap.startTLS }}
          insecureSkipVerify: {{ default false .Values.skyforge.dex.ldap.insecureSkipVerify }}
          bindDN: {{ default "" .Values.skyforge.dex.ldap.bindDN | quote }}
          bindPW: {{ default "" .Values.skyforge.dex.ldap.bindPW | quote }}
          usernamePrompt: {{ default "LDAP Username" .Values.skyforge.dex.ldap.usernamePrompt | quote }}
          userSearch:
            baseDN: {{ default "" .Values.skyforge.dex.ldap.userSearch.baseDN | quote }}
            filter: {{ default "(objectClass=person)" .Values.skyforge.dex.ldap.userSearch.filter | quote }}
            username: {{ default "uid" .Values.skyforge.dex.ldap.userSearch.username | quote }}
            idAttr: {{ default "uid" .Values.skyforge.dex.ldap.userSearch.idAttr | quote }}
            emailAttr: {{ default "mail" .Values.skyforge.dex.ldap.userSearch.emailAttr | quote }}
            nameAttr: {{ default "cn" .Values.skyforge.dex.ldap.userSearch.nameAttr | quote }}
{{- end }}
{{- if $useOkta }}
      - type: oidc
        id: okta
        name: {{ $oktaName | quote }}
        config:
          issuer: {{ $oktaIssuer | quote }}
          clientID: {{ $oktaClientID | quote }}
          clientSecret: {{ $oktaClientSecret | quote }}
          redirectURI: {{ printf "https://%s/dex/callback" $hostname | quote }}
{{- if $oktaScopes }}
          scopes:
{{- range $oktaScopes }}
            - {{ . | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- if not $hasConnector }}
      - type: mockCallback
        id: mock
        name: "Mock"
        config: {}
{{- end }}
    staticClients:
      - id: skyforge
        name: Skyforge
        secret: {{ $skyforgeOIDCClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/api/oidc/callback" $hostname | quote }}
{{- if .Values.skyforge.gitea.enabled }}
      - id: gitea
        name: Gitea
        secret: {{ $giteaClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/git/user/oauth2/oidc/callback" $hostname | quote }}
{{- end }}
{{- if .Values.skyforge.coder.enabled }}
      - id: coder
        name: Coder
        secret: {{ $coderClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/coder/oauth2/callback" $hostname | quote }}
          - {{ printf "https://%s/api/v2/users/oidc/callback" $hostname | quote }}
{{- end }}
{{- if .Values.skyforge.yaade.enabled }}
      - id: yaade
        name: Yaade
        secret: {{ $yaadeClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/api-testing/api/oauth2/callback" $hostname | quote }}
          - {{ printf "https://%s/api-testing/callback-dex" $hostname | quote }}
{{- end }}
{{- if .Values.skyforge.netbox.enabled }}
      - id: netbox
        name: NetBox
        secret: {{ $netboxClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/netbox/oauth/complete/oidc/" $hostname | quote }}
{{- end }}
{{- if .Values.skyforge.nautobot.enabled }}
      - id: nautobot
        name: Nautobot
        secret: {{ $nautobotClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/nautobot/oauth/complete/oidc/" $hostname | quote }}
          - {{ printf "https://%s/nautobot/complete/oidc/" $hostname | quote }}
{{- end }}
{{- end }}

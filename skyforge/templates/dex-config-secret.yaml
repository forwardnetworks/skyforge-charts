{{- if and .Values.skyforge.dex.enabled .Values.skyforge.dex.manageConfig -}}
{{- /*
Generate Dex config from Helm values and existing Secrets.

We intentionally keep Dex's static client secrets in Kubernetes Secrets that are
also consumed by the corresponding applications (Skyforge, Coder). Dex requires
the raw secret in its config, so we hydrate it here from either:
  - the existing Secret (upgrade path), or
  - the Helm values (fresh install path).
*/ -}}

{{- $hostname := required "skyforge.hostname is required" .Values.skyforge.hostname -}}

{{- $dexDbPassword := include "skyforge.secretOrValue" (list . "db-dex-password" "db-dex-password" (index (index .Values.secrets.items "db-dex-password") "db-dex-password" | default "")) -}}
{{- if not $dexDbPassword -}}
  {{- fail "db-dex-password.db-dex-password must be set (Dex uses Postgres storage)" -}}
{{- end -}}

{{- $skyforgeOIDCClientSecret := include "skyforge.secretOrValue" (list . "skyforge-oidc-client-secret" "skyforge-oidc-client-secret" (index (index .Values.secrets.items "skyforge-oidc-client-secret") "skyforge-oidc-client-secret" | default "")) -}}
{{- if not $skyforgeOIDCClientSecret -}}
  {{- fail "skyforge-oidc-client-secret.skyforge-oidc-client-secret must be set (Dex static client 'skyforge')" -}}
{{- end -}}

{{- $coderClientSecret := include "skyforge.secretOrValue" (list . "dex-client-coder-secret" "dex-client-coder-secret" (index (index .Values.secrets.items "dex-client-coder-secret") "dex-client-coder-secret" | default "")) -}}
{{- if and .Values.skyforge.coder.enabled (not $coderClientSecret) -}}
  {{- fail "dex-client-coder-secret.dex-client-coder-secret must be set (Dex static client 'coder')" -}}
{{- end -}}

{{- $authMode := default "google" .Values.skyforge.dex.authMode -}}

{{- $googleClientID := "" -}}
{{- $googleClientSecret := "" -}}
{{- $googleHostedDomains := default (list) .Values.skyforge.dex.google.hostedDomains -}}
{{- if eq $authMode "google" -}}
  {{- $googleClientID = required "skyforge.dex.google.clientID is required when authMode=google" .Values.skyforge.dex.google.clientID -}}
  {{- $googleClientSecret = include "skyforge.secretOrValue" (list . (default "dex-google-client-secret" .Values.skyforge.dex.google.clientSecretSecretName) (default "dex-google-client-secret" .Values.skyforge.dex.google.clientSecretSecretKey) (index (index .Values.secrets.items "dex-google-client-secret") "dex-google-client-secret" | default "")) -}}
  {{- if not $googleClientSecret -}}
    {{- fail "dex-google-client-secret.dex-google-client-secret must be set (Google connector client secret)" -}}
  {{- end -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: dex-config
  annotations:
    "helm.sh/resource-policy": keep
  labels:
{{ include "skyforge.labels" . | indent 4 }}
type: Opaque
stringData:
  config.yaml: |
    issuer: https://{{ $hostname }}/dex
    storage:
      type: postgres
      config:
        host: db
        port: 5432
        database: dex
        user: dex
        password: {{ $dexDbPassword | quote }}
        ssl:
          mode: disable
    web:
      http: 0.0.0.0:5556
    oauth2:
      skipApprovalScreen: true
      alwaysShowLoginScreen: false
    connectors:
{{- if eq $authMode "google" }}
      - type: google
        id: google
        name: Google
        config:
          clientID: {{ $googleClientID | quote }}
          clientSecret: {{ $googleClientSecret | quote }}
          redirectURI: {{ printf "https://%s/dex/callback" $hostname | quote }}
{{- if $googleHostedDomains }}
          hostedDomains:
{{- range $googleHostedDomains }}
            - {{ . | quote }}
{{- end }}
{{- end }}
{{- else if eq $authMode "ldap" }}
      - type: ldap
        id: ldap
        name: LDAP
        config:
          # NOTE: LDAP is supported for OSS installs but is disabled by default.
          # Populate these via deploy/skyforge-secrets.yaml (or similar) if needed.
          host: {{ default "" .Values.skyforge.dex.ldap.host | quote }}
          startTLS: {{ default false .Values.skyforge.dex.ldap.startTLS }}
          insecureSkipVerify: {{ default false .Values.skyforge.dex.ldap.insecureSkipVerify }}
          bindDN: {{ default "" .Values.skyforge.dex.ldap.bindDN | quote }}
          bindPW: {{ default "" .Values.skyforge.dex.ldap.bindPW | quote }}
          usernamePrompt: {{ default "LDAP Username" .Values.skyforge.dex.ldap.usernamePrompt | quote }}
          userSearch:
            baseDN: {{ default "" .Values.skyforge.dex.ldap.userSearch.baseDN | quote }}
            filter: {{ default "(objectClass=person)" .Values.skyforge.dex.ldap.userSearch.filter | quote }}
            username: {{ default "uid" .Values.skyforge.dex.ldap.userSearch.username | quote }}
            idAttr: {{ default "uid" .Values.skyforge.dex.ldap.userSearch.idAttr | quote }}
            emailAttr: {{ default "mail" .Values.skyforge.dex.ldap.userSearch.emailAttr | quote }}
            nameAttr: {{ default "cn" .Values.skyforge.dex.ldap.userSearch.nameAttr | quote }}
{{- else }}
      - type: mockCallback
        id: mock
        name: "Mock"
        config: {}
{{- end }}
    staticClients:
      - id: skyforge
        name: Skyforge
        secret: {{ $skyforgeOIDCClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/api/oidc/callback" $hostname | quote }}
{{- if .Values.skyforge.coder.enabled }}
      - id: coder
        name: Coder
        secret: {{ $coderClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/coder/oauth2/callback" $hostname | quote }}
          - {{ printf "https://%s/api/v2/users/oidc/callback" $hostname | quote }}
{{- end }}
{{- end }}

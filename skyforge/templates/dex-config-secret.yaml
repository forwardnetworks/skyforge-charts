{{- if and .Values.skyforge.dex.enabled .Values.skyforge.dex.manageConfig -}}
{{- /*
Generate Dex config from Helm values and existing Secrets.

We intentionally keep Dex's static client secrets in Kubernetes Secrets that are
also consumed by the corresponding applications (Skyforge, Coder). Dex requires
the raw secret in its config, so we hydrate it here from either:
  - the existing Secret (upgrade path), or
  - the Helm values (fresh install path).
*/ -}}

{{- $hostname := required "skyforge.hostname is required" .Values.skyforge.hostname -}}
{{- $secretItems := (default (dict) .Values.secrets.items) -}}

{{- $dexDbPassword := include "skyforge.secretOrValue" (list . "db-dex-password" "db-dex-password" (index (default (dict) (index $secretItems "db-dex-password")) "db-dex-password" | default "")) -}}
{{- if not $dexDbPassword -}}
  {{- fail "db-dex-password.db-dex-password must be set (Dex uses Postgres storage)" -}}
{{- end -}}

{{- $skyforgeOIDCClientSecret := include "skyforge.secretOrValue" (list . "skyforge-oidc-client-secret" "skyforge-oidc-client-secret" (index (default (dict) (index $secretItems "skyforge-oidc-client-secret")) "skyforge-oidc-client-secret" | default "")) -}}
{{- if not $skyforgeOIDCClientSecret -}}
  {{- fail "skyforge-oidc-client-secret.skyforge-oidc-client-secret must be set (Dex static client 'skyforge')" -}}
{{- end -}}

{{- $coderClientSecret := include "skyforge.secretOrValue" (list . "dex-client-coder-secret" "dex-client-coder-secret" (index (default (dict) (index $secretItems "dex-client-coder-secret")) "dex-client-coder-secret" | default "")) -}}
{{- if and .Values.skyforge.coder.enabled (not $coderClientSecret) -}}
  {{- fail "dex-client-coder-secret.dex-client-coder-secret must be set (Dex static client 'coder')" -}}
{{- end -}}

{{- $giteaClientSecret := include "skyforge.secretOrValue" (list . "dex-client-gitea-secret" "dex-client-gitea-secret" (index (default (dict) (index $secretItems "dex-client-gitea-secret")) "dex-client-gitea-secret" | default "")) -}}
{{- $yaadeClientSecret := include "skyforge.secretOrValue" (list . "dex-client-yaade-secret" "dex-client-yaade-secret" (index (default (dict) (index $secretItems "dex-client-yaade-secret")) "dex-client-yaade-secret" | default "")) -}}
{{- $netboxClientSecret := include "skyforge.secretOrValue" (list . "dex-client-netbox-secret" "dex-client-netbox-secret" (index (default (dict) (index $secretItems "dex-client-netbox-secret")) "dex-client-netbox-secret" | default "")) -}}
{{- $nautobotClientSecret := include "skyforge.secretOrValue" (list . "dex-client-nautobot-secret" "dex-client-nautobot-secret" (index (default (dict) (index $secretItems "dex-client-nautobot-secret")) "dex-client-nautobot-secret" | default "")) -}}

{{- $authMode := default "local" .Values.skyforge.dex.authMode -}}
{{- if and (ne $authMode "local") (ne $authMode "google") (ne $authMode "oidc") (ne $authMode "ldap") (ne $authMode "mock") -}}
  {{- fail (printf "unsupported skyforge.dex.authMode=%q (supported: local, google, oidc, ldap, mock)" $authMode) -}}
{{- end -}}

{{- $localUsername := default "skyforge" .Values.skyforge.dex.local.username -}}
{{- $localEmailDefault := printf "%s@%s" $localUsername $hostname -}}
{{- $localEmail := default $localEmailDefault .Values.skyforge.dex.local.email -}}
{{- $localUserID := default $localUsername .Values.skyforge.dex.local.userID -}}
{{- $localPasswordHash := default "" .Values.skyforge.dex.local.passwordHash -}}
{{- if eq $authMode "local" -}}
  {{- if not $localPasswordHash -}}
    {{- $localPassword := include "skyforge.secretOrValue" (list . "skyforge-admin-shared" "password" (index (default (dict) (index $secretItems "skyforge-admin-shared")) "password" | default "")) -}}
    {{- if not $localPassword -}}
      {{- fail "skyforge.dex.authMode=local requires skyforge-admin-shared.password (or skyforge.dex.local.passwordHash)" -}}
    {{- end -}}
    {{- $localPasswordHash = (index (splitList ":" (htpasswd $localUsername $localPassword)) 1) -}}
  {{- end -}}
{{- end -}}

{{- $googleClientID := "" -}}
{{- $googleClientSecret := "" -}}
{{- $googleHostedDomains := default (list) .Values.skyforge.dex.google.hostedDomains -}}
{{- if eq $authMode "google" -}}
  {{- $googleClientID = required "skyforge.dex.google.clientID is required when authMode=google" .Values.skyforge.dex.google.clientID -}}
  {{- $googleClientSecret = include "skyforge.secretOrValue" (list . (default "dex-google-client-secret" .Values.skyforge.dex.google.clientSecretSecretName) (default "dex-google-client-secret" .Values.skyforge.dex.google.clientSecretSecretKey) (index (default (dict) (index $secretItems "dex-google-client-secret")) "dex-google-client-secret" | default "")) -}}
  {{- if not $googleClientSecret -}}
    {{- fail "dex-google-client-secret.dex-google-client-secret must be set (Google connector client secret)" -}}
  {{- end -}}
{{- end -}}

{{- $oidcIssuer := "" -}}
{{- $oidcClientID := "" -}}
{{- $oidcClientSecret := "" -}}
{{- $oidcRedirectURI := printf "https://%s/dex/callback" $hostname -}}
{{- $oidcValues := default (dict) .Values.skyforge.dex.oidc -}}
{{- $oidcScopes := default (list "openid" "profile" "email" "groups") (index $oidcValues "scopes") -}}
{{- $oidcInsecureSkipEmailVerified := default false (index $oidcValues "insecureSkipEmailVerified") -}}
{{- if eq $authMode "oidc" -}}
  {{- $oidcIssuer = required "skyforge.dex.oidc.issuer is required when authMode=oidc" (index $oidcValues "issuer") -}}
  {{- $oidcClientID = required "skyforge.dex.oidc.clientID is required when authMode=oidc" (index $oidcValues "clientID") -}}
  {{- $oidcClientSecret = include "skyforge.secretOrValue" (list . (default "dex-oidc-client-secret" (index $oidcValues "clientSecretSecretName")) (default "dex-oidc-client-secret" (index $oidcValues "clientSecretSecretKey")) (index (default (dict) (index $secretItems "dex-oidc-client-secret")) "dex-oidc-client-secret" | default "")) -}}
  {{- if not $oidcClientSecret -}}
    {{- fail "dex-oidc-client-secret.dex-oidc-client-secret must be set (OIDC connector client secret)" -}}
  {{- end -}}
  {{- if (index $oidcValues "redirectURI") -}}
    {{- $oidcRedirectURI = (index $oidcValues "redirectURI") -}}
  {{- end -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: dex-config
  annotations:
    "helm.sh/resource-policy": keep
  labels:
{{ include "skyforge.labels" . | indent 4 }}
type: Opaque
stringData:
  config.yaml: |
    issuer: https://{{ $hostname }}/dex
    storage:
      type: postgres
      config:
        host: db
        port: 5432
        database: dex
        user: dex
        password: {{ $dexDbPassword | quote }}
        ssl:
          mode: disable
    web:
      http: 0.0.0.0:5556
    oauth2:
      skipApprovalScreen: true
      alwaysShowLoginScreen: false
{{- if ne $authMode "local" }}
    connectors:
{{- if eq $authMode "google" }}
      - type: google
        id: google
        name: Google
        config:
          clientID: {{ $googleClientID | quote }}
          clientSecret: {{ $googleClientSecret | quote }}
          redirectURI: {{ printf "https://%s/dex/callback" $hostname | quote }}
{{- if $googleHostedDomains }}
          hostedDomains:
{{- range $googleHostedDomains }}
            - {{ . | quote }}
{{- end }}
{{- end }}
{{- else if eq $authMode "oidc" }}
      - type: oidc
        id: oidc
        name: OIDC
        config:
          issuer: {{ $oidcIssuer | quote }}
          clientID: {{ $oidcClientID | quote }}
          clientSecret: {{ $oidcClientSecret | quote }}
          redirectURI: {{ $oidcRedirectURI | quote }}
{{- if $oidcScopes }}
          scopes:
{{- range $oidcScopes }}
            - {{ . | quote }}
{{- end }}
{{- end }}
          insecureSkipEmailVerified: {{ $oidcInsecureSkipEmailVerified }}
{{- else if eq $authMode "ldap" }}
      - type: ldap
        id: ldap
        name: LDAP
        config:
          # NOTE: LDAP is supported for OSS installs but is disabled by default.
          # Populate these via deploy/skyforge-secrets.yaml (or similar) if needed.
          host: {{ default "" .Values.skyforge.dex.ldap.host | quote }}
          startTLS: {{ default false .Values.skyforge.dex.ldap.startTLS }}
          insecureSkipVerify: {{ default false .Values.skyforge.dex.ldap.insecureSkipVerify }}
          bindDN: {{ default "" .Values.skyforge.dex.ldap.bindDN | quote }}
          bindPW: {{ default "" .Values.skyforge.dex.ldap.bindPW | quote }}
          usernamePrompt: {{ default "LDAP Username" .Values.skyforge.dex.ldap.usernamePrompt | quote }}
          userSearch:
            baseDN: {{ default "" .Values.skyforge.dex.ldap.userSearch.baseDN | quote }}
            filter: {{ default "(objectClass=person)" .Values.skyforge.dex.ldap.userSearch.filter | quote }}
            username: {{ default "uid" .Values.skyforge.dex.ldap.userSearch.username | quote }}
            idAttr: {{ default "uid" .Values.skyforge.dex.ldap.userSearch.idAttr | quote }}
            emailAttr: {{ default "mail" .Values.skyforge.dex.ldap.userSearch.emailAttr | quote }}
            nameAttr: {{ default "cn" .Values.skyforge.dex.ldap.userSearch.nameAttr | quote }}
{{- else }}
      - type: mockCallback
        id: mock
        name: "Mock"
        config: {}
{{- end }}
{{- else }}
    enablePasswordDB: true
    staticPasswords:
      - email: {{ $localEmail | quote }}
        hash: {{ $localPasswordHash | quote }}
        username: {{ $localUsername | quote }}
        userID: {{ $localUserID | quote }}
{{- end }}
    staticClients:
      - id: skyforge
        name: Skyforge
        secret: {{ $skyforgeOIDCClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/api/oidc/callback" $hostname | quote }}
{{- if and .Values.skyforge.gitea.enabled $giteaClientSecret }}
      - id: gitea
        name: Gitea
        secret: {{ $giteaClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/git/user/oauth2/oidc/callback" $hostname | quote }}
{{- end }}
{{- if .Values.skyforge.coder.enabled }}
      - id: coder
        name: Coder
        secret: {{ $coderClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/coder/oauth2/callback" $hostname | quote }}
          - {{ printf "https://%s/api/v2/users/oidc/callback" $hostname | quote }}
{{- end }}
{{- if and .Values.skyforge.yaade.enabled $yaadeClientSecret }}
      - id: yaade
        name: Yaade
        secret: {{ $yaadeClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/api-testing/api/oauth2/callback" $hostname | quote }}
          - {{ printf "https://%s/api-testing/callback-dex" $hostname | quote }}
{{- end }}
{{- if and .Values.skyforge.netbox.enabled $netboxClientSecret }}
      - id: netbox
        name: NetBox
        secret: {{ $netboxClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/netbox/oauth/complete/oidc/" $hostname | quote }}
{{- end }}
{{- if and .Values.skyforge.nautobot.enabled $nautobotClientSecret }}
      - id: nautobot
        name: Nautobot
        secret: {{ $nautobotClientSecret | quote }}
        redirectURIs:
          - {{ printf "https://%s/nautobot/oauth/complete/oidc/" $hostname | quote }}
          - {{ printf "https://%s/nautobot/complete/oidc/" $hostname | quote }}
{{- end }}
{{- end }}
